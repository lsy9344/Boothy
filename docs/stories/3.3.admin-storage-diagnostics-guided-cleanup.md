# Story 3.3: Admin Storage Diagnostics + Recovery Actions

## Status

Done

## Story

**As a** booth admin,  
**I want** to view current storage health and perform minimal recovery actions,  
**so that** I can prevent downtime and data loss when disk space runs low.

[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#goal]

## Acceptance Criteria

1. Given admin mode is unlocked, the UI exposes an **Admin Storage Diagnostics** view/panel that is hidden in customer mode (hide; do not disable controls).
   - Shows active session paths (base/raw/jpg) and the sessions root.
2. Given the active session exists, the Admin Storage Diagnostics view shows the current drive free space/total for the drive that contains the sessions root (or active session base path), plus the warning/critical thresholds currently configured in settings.
3. Given admin requests it, the app can open the sessions root in Windows File Explorer as a recovery action.
4. Given an admin action or diagnostics refresh succeeds or fails, the UI surfaces results using the existing customer-safe vs admin diagnostics error/message split, and the admin view can refresh updated free space without restarting the app.
5. Existing session folder structure remains unchanged (`<session>\\{Raw,Jpg}`) and the workflow remains offline-first (no new network dependencies).

[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]

## Tasks / Subtasks

- [x] Task 1: Backend: settings + diagnostics payload + command (AC: 1, 2, 4)
  - [x] Add threshold fields to `apps/boothy/src-tauri/src/file_management.rs` (`AppSettings`) as append-only optional keys:
    - `boothy_storage_warning_threshold_bytes: Option<u64>`
    - `boothy_storage_critical_threshold_bytes: Option<u64>`
  - [x] Ensure these keys are written into `settings.json` using the existing Boothy settings style (snake keys) by adding explicit serde renames:
    - `#[serde(default, rename = "boothy_storage_warning_threshold_bytes")]`
    - `#[serde(default, rename = "boothy_storage_critical_threshold_bytes")]`
    - Rationale: `AppSettings` uses `rename_all = "camelCase"` but existing Boothy keys intentionally stay snake (e.g., `boothy_end_screen_message`).
  - [x] Add a new Tauri command in `apps/boothy/src-tauri/src/main.rs`:
    - Name: `boothy_get_storage_diagnostics`
    - Return a single JSON payload so the admin view can refresh on demand.
    - Required payload shape (exact keys):
      - `ok` (boolean)
      - `data` (object when ok=true; null when ok=false)
      - `error` (object when ok=false; null when ok=true)
    - `data` required keys:
      - `sessions_root` (string; derived from `apps/boothy/src-tauri/src/session/manager.rs` sessions-root logic)
      - `active_session` (optional; reuse `state.session_manager.get_active_session()`; contains `base_path/raw_path/jpg_path`)
      - `drive_free_bytes` (u64)
      - `drive_total_bytes` (u64)
      - `warning_threshold_bytes` (optional u64; from settings)
      - `critical_threshold_bytes` (optional u64; from settings)
      - `captured_at` (ISO string)
    - `error` type:
      - Reuse `apps/boothy/src-tauri/src/error.rs` `UiErrorPayload` (message + diagnostic + context + severity + correlationId) so the admin UI can show `diagnostic` only in admin mode.
  - [x] Implement drive space lookup with a concrete choice:
    - Add dependency `fs2` to `apps/boothy/src-tauri/Cargo.toml` and use `fs2::available_space(path)` / `fs2::total_space(path)` against the sessions root (or active session base path).
  - [x] Register `boothy_get_storage_diagnostics` in the `tauri::generate_handler!` list (near other `boothy_*` commands).
  - [x] Error handling requirement:
    - When diagnostics fail, return an error that is customer-safe by default, but include admin diagnostics details in the admin UI (reuse the existing `apps/boothy/src-tauri/src/error.rs` patterns where possible).

- [x] Task 2: Backend: open sessions root in Explorer (AC: 3, 4)
  - [x] Add a new Tauri command in `apps/boothy/src-tauri/src/main.rs`:
    - Name: `boothy_open_sessions_root_in_explorer`
    - On Windows: open the directory via `Command::new("explorer").arg(sessions_root).spawn()`
    - Use `apps/boothy/src-tauri/src/file_management.rs` (`show_in_finder`) as a reference for platform gating and `Command` usage, but open the directory (not `/select,`).
  - [x] Register the command in `tauri::generate_handler!`.

- [x] Task 3: Frontend: Admin Storage Diagnostics view + wiring (AC: 1-4)
  - [x] Add new invoke constants in `apps/boothy/src/components/ui/AppProperties.tsx`:
    - `BoothyGetStorageDiagnostics = 'boothy_get_storage_diagnostics'`
    - `BoothyOpenSessionsRootInExplorer = 'boothy_open_sessions_root_in_explorer'`
  - [x] Extend the TS `AppSettings` type in `apps/boothy/src/components/ui/AppProperties.tsx` so the UI can read threshold config:
    - `boothy_storage_warning_threshold_bytes?: number;`
    - `boothy_storage_critical_threshold_bytes?: number;`
  - [x] UI placement (keep minimal + consistent with current structure):
    - Preferred: add an admin-only "Storage" section inside `apps/boothy/src/components/panel/SettingsPanel.tsx`.
    - Pass `isAdmin={boothyMode === 'admin'}` from `apps/boothy/src/App.tsx` and do not render this section in customer mode.
      - [Source: docs/frontend-architecture.md#ui-gating-rules]
      - [Source: docs/design_concept.md]
  - [x] UI must render at minimum:
    - Sessions root path + "Open in Explorer" button.
    - Active session base/raw/jpg paths (or "No active session").
    - Drive free/total bytes (display in GB for readability, but keep raw bytes in payload).
    - Thresholds (if null, show "Unset" and explain it is configured via settings.json).
    - "Refresh" button and a visible last-updated timestamp (`captured_at`).
  - [x] Add stable mocks in `apps/boothy/src/tauriMock.ts` so dev mode remains usable:
    - `boothy_get_storage_diagnostics` returns a deterministic payload (use the existing mock session paths).
    - `boothy_open_sessions_root_in_explorer` returns null (no-op).

- [x] Task 4: Tests + validation scenarios (AC: 1-5)
  - [x] Backend unit tests (minimal but real):
    - Add at least one test for sessions root derivation logic (use a temp override or extract a helper that can be tested without relying on the real `USERPROFILE`).
    - Add at least one test for the drive stats function (if it cannot be reliably tested on CI, assert the error is well-formed and customer-safe).
  - [x] Manual MVP gate:
    - In admin mode, open the diagnostics view and verify sessions root + active session paths are displayed.
    - Click "Refresh" and verify `captured_at` updates and drive stats change when disk usage changes.
    - Click "Open in Explorer" and verify the sessions root folder opens.
    - Switch to customer mode and verify the diagnostics view is not visible.
    - Force an error condition (temporarily unset `USERPROFILE` for a dev run or simulate via mock) and verify customer-safe vs admin diagnostics behavior.
    - [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  - [x] Regression: confirm session folder contract unchanged and offline-first behavior preserved.
    - [Source: docs/architecture/testing-strategy.md#regression-testing]
    - [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#compatibility-requirements]

## Dev Notes

### Previous Story Insights

- Admin mode unlock and mode gating already exist (password modal + mode events); reuse the existing mode single source of truth and hide-not-disable policy rather than introducing a parallel auth state.
  - [Source: docs/stories/1.1.booth-app-foundation-session-mode-gating.md#dev-agent-record]
- Structured error handling with customer-safe vs admin diagnostics split is established; new storage/diagnostics errors should follow the same pattern.
  - [Source: docs/stories/1.3.production-hardening-admin-surface-packaging-diagnostics.md#dev-agent-record]

### Scope / Boundaries

- Guided cleanup (safe deletion of old sessions) is handled in Story 3.4; keep Story 3.3 focused on diagnostics + minimal recovery action(s).
  - [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
  - [Source: docs/stories/3.4.admin-guided-cleanup-safe-old-session-deletion.md]

### Data Models / Settings (code-aligned)

- Sessions root is currently derived in code as `%USERPROFILE%\\Pictures\\dabi_shoot` (not user-configurable in MVP).
  - [Source: apps/boothy/src-tauri/src/session/manager.rs]
- Settings persistence is `settings.json` in AppData via `apps/boothy/src-tauri/src/file_management.rs` (`load_settings` / `save_settings`).
  - [Source: apps/boothy/src-tauri/src/file_management.rs]
- Existing Boothy settings keys are flat (not nested) and often snake-named; keep new threshold keys consistent to avoid breaking existing data.

### UI Implementation Notes (code-aligned)

- Admin/customer mode is already tracked in `apps/boothy/src/App.tsx` as `boothyMode` and used for gating; reuse this and hide the diagnostics view in customer mode.
  - [Source: apps/boothy/src/App.tsx]
- Existing settings panel is `apps/boothy/src/components/panel/SettingsPanel.tsx`; adding an admin-only section here minimizes navigation changes.

### Testing

- Prefer focused Rust unit tests close to the new helper/command logic (avoid brittle full integration tests for this story).
  - [Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-22 | 0.1 | Initial draft created from Epic 3 + architecture | Scrum Master (Bob) |
| 2026-01-22 | 0.2 | Clarify scope (deletion moved to Story 3.4), fix encoding and source anchors | Product Owner (Sarah) |
| 2026-01-22 | 0.3 | Increase implementation readiness: concrete commands, settings keys, file touchpoints, tests, and mocks | Product Owner (Sarah) |
| 2026-01-24 | 0.4 | QA fixes: show critical threshold + add storage diagnostics mocks | Dev (James) |

## Dev Agent Record

### Agent Model Used

GPT-5

### Debug Log References

- Playwright launch blocked by system Chrome policy (browser_navigate failure).
- `deno lint` (failed: pre-existing lint violations across repo, incl. reference/ and apps/boothy files).
- `deno test -A` (failed: Deno type-check errors + missing npm deps for vitest/testing-library).
- `npm test` (apps/boothy) - pass with es2024/Vite CJS warnings.

### Completion Notes List

- Added storage diagnostics commands and admin-only UI wiring with deterministic mocks.
- Added drive stats and sessions root tests; `cargo test` passed (warnings only in upstream/reference code).
- Manual MVP checklist verified by user (admin/customer visibility, data correctness, explorer open, refresh timestamp, error handling).
- Regression verified by inspection: session folder contract unchanged and no new network dependencies.
- Tests: `cargo test` (warnings in upstream/reference code) and `npm test` (es2024 target/Vite CJS warnings).
- QA fixes: added critical threshold display and stable storage diagnostics mocks for dev mode.
- Validation: deno installed via winget; deno lint/test fail due to existing repo lint/type-check issues; ran `npm test` with warnings only.

### File List

- `apps/boothy/src-tauri/Cargo.toml`
- `apps/boothy/src-tauri/Cargo.lock`
- `apps/boothy/src-tauri/src/error.rs`
- `apps/boothy/src-tauri/src/main.rs`
- `apps/boothy/src-tauri/src/session/manager.rs`
- `apps/boothy/src-tauri/src/storage_diagnostics.rs`
- `apps/boothy/src/App.tsx`
- `apps/boothy/src/components/panel/MainLibrary.tsx`
- `apps/boothy/src/components/panel/SettingsPanel.tsx`
- `apps/boothy/src/components/ui/AppProperties.tsx`
- `apps/boothy/src/tauriMock.ts`

## QA Results

TBD

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

전반적으로 요구된 Tauri 커맨드/데이터 구조와 설정 키 확장이 일관되게 구현되어 있고, Rust 유닛 테스트도 추가되어 있습니다. 다만 Admin UI에 **critical threshold 표시가 누락**되어 AC2가 부분 충족 상태이며, dev mock이 누락되어 로컬 개발/테스트 안정성이 떨어집니다.

- 실행한 테스트:
  - `cargo test` (apps/boothy/src-tauri): 통과. 기존 reference 코드/unused 관련 경고 다수.
  - `npm test` (apps/boothy): 통과. `es2024` target 인식 경고 및 Vite CJS API deprecation 경고 존재.

### Requirements Traceability (Given/When/Then)

- **AC1** (Admin 전용 진입 + 경로 표시)
  - Given admin mode unlocked, When settings panel is rendered, Then Admin Storage Diagnostics 섹션이 렌더되고 sessions root + active session paths가 표시된다.
  - **Test coverage:** 자동화 테스트 없음 (UI 수동 확인 필요).
- **AC2** (드라이브 용량 + 경고/임계 threshold 노출)
  - Given active session or sessions root, When diagnostics refresh, Then drive free/total + warning/critical thresholds가 표시된다.
  - **Test coverage:** `storage_diagnostics::tests::sample_drive_stats_returns_values` (백엔드 샘플링). UI에 **critical threshold 표시 누락**으로 부분 충족.
- **AC3** (Explorer 열기)
  - Given admin action, When "Open in Explorer" 요청, Then 세션 루트가 Explorer에서 열린다.
  - **Test coverage:** 자동화 테스트 없음 (수동 확인 필요).
- **AC4** (성공/실패 메시지 + refresh)
  - Given diagnostics refresh succeeds/fails, When response returns, Then 고객 안전 메시지 + admin diagnostics 분리 표시 및 갱신 가능.
  - **Test coverage:** 자동화 테스트 없음 (UI 수동 확인 필요).
- **AC5** (세션 구조/오프라인 유지)
  - Given existing session workflow, When diagnostics 기능 추가, Then `<session>\\{Raw,Jpg}` 구조는 유지되고 offline-first 위배 없음.
  - **Test coverage:** `session::manager` 경로 생성 테스트로 간접 검증 + 코드 리뷰 기반.

### Refactoring Performed

없음.

### Compliance Check

- Coding Standards: PASS (boothy_* 네이밍 및 기존 패턴 준수)
- Project Structure: PASS (docs/architecture/source-tree.md 기준; unified-project-structure.md 미존재)
- Testing Strategy: PARTIAL (백엔드 유닛 테스트 추가됨, UI/모크 테스트 부재)
- All ACs Met: CONCERNS (AC2 critical threshold UI 누락)

### Improvements Checklist

- [ ] Admin Storage Diagnostics UI에 **Critical Threshold** 표시 추가 (`apps/boothy/src/components/panel/SettingsPanel.tsx`)
- [ ] `tauriMock.ts`에 `boothy_get_storage_diagnostics` / `boothy_open_sessions_root_in_explorer` 안정 mock 추가
- [ ] Admin Diagnostics 렌더/숨김 및 refresh 동작에 대한 UI 테스트 추가 (선택)

### Security Review

로컬 파일 시스템 조회 및 Explorer 실행만 수행. 외부 네트워크/권한 상승 없음. UiErrorPayload 사용으로 고객 메시지/관리자 진단 분리 흐름 유지.

### Performance Considerations

fs2 공간 조회는 O(1) 수준으로 부담 낮음. 주기적 refresh에 따른 성능 리스크는 낮음.

### Files Modified During Review

없음.

### Gate Status

Gate: CONCERNS — docs/qa/gates/3.3-admin-storage-diagnostics-recovery-actions.yml  
Risk profile: Not created (not requested)  
NFR assessment: Not created (not requested)

### Recommended Status

Changes Required - 위 체크리스트 미해결 항목 반영 후 재검토 권장.

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

수정사항 반영 확인: Admin Storage Diagnostics UI에 critical threshold 표시가 추가되었고, `tauriMock`에 진단/Explorer 명령 모크가 추가되어 dev 모드 안정성이 개선되었습니다. 전반적으로 구현은 요구사항과 일치합니다.

- 실행한 테스트:
  - `cargo test` (apps/boothy/src-tauri): 통과. 기존 reference 코드/unused 관련 경고 다수.
  - `npm test` (apps/boothy): 통과. `es2024` target 인식 경고 및 Vite CJS API deprecation 경고 존재.

### Requirements Traceability (Given/When/Then)

- **AC1** Admin 전용 UI 노출 + 경로 표시: 구현 확인 (수동 검증 필요).
- **AC2** 드라이브 용량 + warning/critical threshold 표시: **critical threshold 표시 확인**.
- **AC3** Explorer 열기: 커맨드/버튼 연결 및 mock 확인 (수동 검증 필요).
- **AC4** 성공/실패 메시지 분리 + refresh: 기존 패턴 준수 (수동 검증 필요).
- **AC5** 세션 구조 유지 + offline-first: 코드/테스트 기반 확인.

### Refactoring Performed

없음.

### Compliance Check

- Coding Standards: PASS
- Project Structure: PASS (docs/architecture/source-tree.md 기준)
- Testing Strategy: PARTIAL (자동 UI 테스트 부족)
- All ACs Met: PASS

### Improvements Checklist

- [ ] (선택) Admin Diagnostics UI 테스트 추가 (visibility/refresh)

### Security Review

보안 이슈 없음. 로컬 파일 시스템 접근 + Explorer 실행만 수행.

### Performance Considerations

성능 리스크 없음(공간 조회는 경량).

### Files Modified During Review

없음.

### Gate Status

Gate: PASS — docs/qa/gates/3.3-admin-storage-diagnostics-recovery-actions.yml  
Risk profile: Not created (not requested)  
NFR assessment: Not created (not requested)

### Recommended Status

Ready for Done
