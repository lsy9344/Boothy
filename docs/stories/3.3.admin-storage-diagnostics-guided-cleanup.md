# Story 3.3: Admin Storage Diagnostics + Recovery Actions

## Status

Approved

## Story

**As a** booth admin,  
**I want** to view current storage health and perform minimal recovery actions,  
**so that** I can prevent downtime and data loss when disk space runs low.

[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#goal]

## Acceptance Criteria

1. Given admin mode is unlocked, the UI exposes an **Admin Storage Diagnostics** view/panel that is hidden in customer mode (hide; do not disable controls).
   - Shows active session paths (base/raw/jpg) and the sessions root.
2. Given the active session exists, the Admin Storage Diagnostics view shows the current drive free space/total for the drive that contains the sessions root (or active session base path), plus the warning/critical thresholds currently configured in settings.
3. Given admin requests it, the app can open the sessions root in Windows File Explorer as a recovery action.
4. Given an admin action or diagnostics refresh succeeds or fails, the UI surfaces results using the existing customer-safe vs admin diagnostics error/message split, and the admin view can refresh updated free space without restarting the app.
5. Existing session folder structure remains unchanged (`<session>\\{Raw,Jpg}`) and the workflow remains offline-first (no new network dependencies).

[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]

## Tasks / Subtasks

- [ ] Task 1: Backend: settings + diagnostics payload + command (AC: 1, 2, 4)
  - [ ] Add threshold fields to `apps/boothy/src-tauri/src/file_management.rs` (`AppSettings`) as append-only optional keys:
    - `boothy_storage_warning_threshold_bytes: Option<u64>`
    - `boothy_storage_critical_threshold_bytes: Option<u64>`
  - [ ] Ensure these keys are written into `settings.json` using the existing Boothy settings style (snake keys) by adding explicit serde renames:
    - `#[serde(default, rename = "boothy_storage_warning_threshold_bytes")]`
    - `#[serde(default, rename = "boothy_storage_critical_threshold_bytes")]`
    - Rationale: `AppSettings` uses `rename_all = "camelCase"` but existing Boothy keys intentionally stay snake (e.g., `boothy_end_screen_message`).
  - [ ] Add a new Tauri command in `apps/boothy/src-tauri/src/main.rs`:
    - Name: `boothy_get_storage_diagnostics`
    - Return a single JSON payload so the admin view can refresh on demand.
    - Required payload shape (exact keys):
      - `ok` (boolean)
      - `data` (object when ok=true; null when ok=false)
      - `error` (object when ok=false; null when ok=true)
    - `data` required keys:
      - `sessions_root` (string; derived from `apps/boothy/src-tauri/src/session/manager.rs` sessions-root logic)
      - `active_session` (optional; reuse `state.session_manager.get_active_session()`; contains `base_path/raw_path/jpg_path`)
      - `drive_free_bytes` (u64)
      - `drive_total_bytes` (u64)
      - `warning_threshold_bytes` (optional u64; from settings)
      - `critical_threshold_bytes` (optional u64; from settings)
      - `captured_at` (ISO string)
    - `error` type:
      - Reuse `apps/boothy/src-tauri/src/error.rs` `UiErrorPayload` (message + diagnostic + context + severity + correlationId) so the admin UI can show `diagnostic` only in admin mode.
  - [ ] Implement drive space lookup with a concrete choice:
    - Add dependency `fs2` to `apps/boothy/src-tauri/Cargo.toml` and use `fs2::available_space(path)` / `fs2::total_space(path)` against the sessions root (or active session base path).
  - [ ] Register `boothy_get_storage_diagnostics` in the `tauri::generate_handler!` list (near other `boothy_*` commands).
  - [ ] Error handling requirement:
    - When diagnostics fail, return an error that is customer-safe by default, but include admin diagnostics details in the admin UI (reuse the existing `apps/boothy/src-tauri/src/error.rs` patterns where possible).

- [ ] Task 2: Backend: open sessions root in Explorer (AC: 3, 4)
  - [ ] Add a new Tauri command in `apps/boothy/src-tauri/src/main.rs`:
    - Name: `boothy_open_sessions_root_in_explorer`
    - On Windows: open the directory via `Command::new("explorer").arg(sessions_root).spawn()`
    - Use `apps/boothy/src-tauri/src/file_management.rs` (`show_in_finder`) as a reference for platform gating and `Command` usage, but open the directory (not `/select,`).
  - [ ] Register the command in `tauri::generate_handler!`.

- [ ] Task 3: Frontend: Admin Storage Diagnostics view + wiring (AC: 1-4)
  - [ ] Add new invoke constants in `apps/boothy/src/components/ui/AppProperties.tsx`:
    - `BoothyGetStorageDiagnostics = 'boothy_get_storage_diagnostics'`
    - `BoothyOpenSessionsRootInExplorer = 'boothy_open_sessions_root_in_explorer'`
  - [ ] Extend the TS `AppSettings` type in `apps/boothy/src/components/ui/AppProperties.tsx` so the UI can read threshold config:
    - `boothy_storage_warning_threshold_bytes?: number;`
    - `boothy_storage_critical_threshold_bytes?: number;`
  - [ ] UI placement (keep minimal + consistent with current structure):
    - Preferred: add an admin-only "Storage" section inside `apps/boothy/src/components/panel/SettingsPanel.tsx`.
    - Pass `isAdmin={boothyMode === 'admin'}` from `apps/boothy/src/App.tsx` and do not render this section in customer mode.
      - [Source: docs/frontend-architecture.md#ui-gating-rules]
      - [Source: docs/design_concept.md]
  - [ ] UI must render at minimum:
    - Sessions root path + "Open in Explorer" button.
    - Active session base/raw/jpg paths (or "No active session").
    - Drive free/total bytes (display in GB for readability, but keep raw bytes in payload).
    - Thresholds (if null, show "Unset" and explain it is configured via settings.json).
    - "Refresh" button and a visible last-updated timestamp (`captured_at`).
  - [ ] Add stable mocks in `apps/boothy/src/tauriMock.ts` so dev mode remains usable:
    - `boothy_get_storage_diagnostics` returns a deterministic payload (use the existing mock session paths).
    - `boothy_open_sessions_root_in_explorer` returns null (no-op).

- [ ] Task 4: Tests + validation scenarios (AC: 1-5)
  - [ ] Backend unit tests (minimal but real):
    - Add at least one test for sessions root derivation logic (use a temp override or extract a helper that can be tested without relying on the real `USERPROFILE`).
    - Add at least one test for the drive stats function (if it cannot be reliably tested on CI, assert the error is well-formed and customer-safe).
  - [ ] Manual MVP gate:
    - In admin mode, open the diagnostics view and verify sessions root + active session paths are displayed.
    - Click "Refresh" and verify `captured_at` updates and drive stats change when disk usage changes.
    - Click "Open in Explorer" and verify the sessions root folder opens.
    - Switch to customer mode and verify the diagnostics view is not visible.
    - Force an error condition (temporarily unset `USERPROFILE` for a dev run or simulate via mock) and verify customer-safe vs admin diagnostics behavior.
    - [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  - [ ] Regression: confirm session folder contract unchanged and offline-first behavior preserved.
    - [Source: docs/architecture/testing-strategy.md#regression-testing]
    - [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#compatibility-requirements]

## Dev Notes

### Previous Story Insights

- Admin mode unlock and mode gating already exist (password modal + mode events); reuse the existing mode single source of truth and hide-not-disable policy rather than introducing a parallel auth state.
  - [Source: docs/stories/1.1.booth-app-foundation-session-mode-gating.md#dev-agent-record]
- Structured error handling with customer-safe vs admin diagnostics split is established; new storage/diagnostics errors should follow the same pattern.
  - [Source: docs/stories/1.3.production-hardening-admin-surface-packaging-diagnostics.md#dev-agent-record]

### Scope / Boundaries

- Guided cleanup (safe deletion of old sessions) is handled in Story 3.4; keep Story 3.3 focused on diagnostics + minimal recovery action(s).
  - [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
  - [Source: docs/stories/3.4.admin-guided-cleanup-safe-old-session-deletion.md]

### Data Models / Settings (code-aligned)

- Sessions root is currently derived in code as `%USERPROFILE%\\Pictures\\dabi_shoot` (not user-configurable in MVP).
  - [Source: apps/boothy/src-tauri/src/session/manager.rs]
- Settings persistence is `settings.json` in AppData via `apps/boothy/src-tauri/src/file_management.rs` (`load_settings` / `save_settings`).
  - [Source: apps/boothy/src-tauri/src/file_management.rs]
- Existing Boothy settings keys are flat (not nested) and often snake-named; keep new threshold keys consistent to avoid breaking existing data.

### UI Implementation Notes (code-aligned)

- Admin/customer mode is already tracked in `apps/boothy/src/App.tsx` as `boothyMode` and used for gating; reuse this and hide the diagnostics view in customer mode.
  - [Source: apps/boothy/src/App.tsx]
- Existing settings panel is `apps/boothy/src/components/panel/SettingsPanel.tsx`; adding an admin-only section here minimizes navigation changes.

### Testing

- Prefer focused Rust unit tests close to the new helper/command logic (avoid brittle full integration tests for this story).
  - [Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-22 | 0.1 | Initial draft created from Epic 3 + architecture | Scrum Master (Bob) |
| 2026-01-22 | 0.2 | Clarify scope (deletion moved to Story 3.4), fix encoding and source anchors | Product Owner (Sarah) |
| 2026-01-22 | 0.3 | Increase implementation readiness: concrete commands, settings keys, file touchpoints, tests, and mocks | Product Owner (Sarah) |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

## QA Results

TBD
