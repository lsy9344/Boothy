# Story 4.2: Admin Camera Diagnostics & Reconnect Workflows

## Status

In Progress

## Story

**As a** booth admin,  
**I want** to see actionable camera/sidecar diagnostics and run a minimal reconnect/retry flow,  
**so that** field failures (camera disconnect, sidecar crash, IPC errors) can be recovered quickly without breaking the offline kiosk workflow.

[Source: docs/stories/epic-4-real-camera-hardware-integration.md#story-sequence-dependency-ordered]  
[Source: docs/prd.md#requirements]

## Context / Problem

- Epic 4(실카메라 E2E)에서 현장 환경(드라이버/SDK/USB 상태/IPC) 문제로 **연결 실패/전송 실패/사이드카 다운**이 빈번하게 발생한다.
- PRD는 **카메라 연결 상태 노출 + 최소 복구 플로우(reconnect/retry) + 고객 안전 메시지 + 관리자 진단**을 요구한다.
- 본 스토리는 복구/진단 UX에 집중하며, capture/전송/ingest 파이프라인(Story 4.1)을 막지 않는 **non-blocking** 동작이 필요하다.

[Source: docs/prd.md#requirements]

## Dependencies / Preconditions

- Story 4.1에서 정의된 camera/sidecar 경로(이벤트 브리지, 세션 `Raw/` 규칙)가 존재해야 하며, 해당 기반 위에 복구 UX를 강화한다.
  [Source: docs/stories/epic-4-real-camera-hardware-integration.md#story-sequence-dependency-ordered]
- `CameraIpcClient.send_request()`의 응답 대기/매칭이 미완일 수 있으므로(현 상태 `{}` 반환 가능), `camera.getStatus`/복구 액션의 신뢰성 확보를 위해 request/response 채널 안정화(대기/타임아웃/에러 매핑)가 선행되어야 한다.
  [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]

## Acceptance Criteria

1. **카메라 연결 상태 노출 + 최소 복구 플로우**
   - Boothy는 카메라 연결 상태(연결/미연결/오류)를 UI에 표시한다.
   - 사용자(최소한 admin)는 “재연결/재시도” 동작을 수행할 수 있다.
   [Source: docs/prd.md#requirements]

2. **고객 모드: 안전 메시지 + 기능 제한(촬영 비활성)**
   - customer 모드에서 capture가 불가능한 경우(미연결/사이드카 오류/필수 의존성 누락) 촬영 UI는 비활성화되고, 한국어 고객 안전 메시지를 표시한다.
   - 해당 상태에서도 기존 browse/edit/export는 계속 가능하며 워크플로우를 막지 않는다.
   [Source: docs/prd.md#requirements]

3. **관리자 모드: 진단 정보 표시**
   - admin 모드에서 다음 진단 정보를 확인할 수 있다(표시 위치는 admin 전용):
     - Sidecar IPC 연결 상태(connected/disconnected/reconnecting) + 마지막 오류 요약
     - `protocolVersion` / `requestId` / `correlationId`
     - `camera.getStatus` 기반의 상태(예: `connected`, `cameraModel`, `sessionDestination`)
   [Source: docs/prd.md#requirements]  
   [Source: docs/architecture/api-design-and-integration.md#tauri-backend--camera-sidecar-named-pipe-rpc]

4. **관리자 모드: 복구 액션 제공**
   - admin 모드에서 최소 1개 이상의 복구 액션을 제공한다: `reconnect` 또는 `restart sidecar`(또는 동등 동작).
   - 복구 시도는 타임아웃/재시도를 포함하고, 실패해도 앱이 크래시하지 않으며 customer 워크플로우를 막지 않는다.
   [Source: docs/prd.md#requirements]  
   [Source: docs/architecture/component-architecture.md#boothy-camera-ipc-client-tauri-backend]

5. **오프라인 정책 준수**
   - 진단/복구 플로우는 네트워크 호출을 추가하지 않는다.
   [Source: docs/prd.md#offline--no-account-policy-mvp]

6. **UI hiding 정책**
   - admin 전용 진단/복구 컨트롤은 customer 모드에서 “비활성화”가 아니라 “숨김” 처리한다.
   [Source: docs/prd.md#requirements]  
   [Source: docs/architecture/security-integration.md#enhancement-security-requirements]

## UI/Command Spec (Story Decision)

### Customer 모드 상태/메시지 규격(고정)

customer 모드에서는 **기술 용어(IPC/sidecar/코드/ID 등)를 노출하지 않는다.**

| 조건(예시) | 상태 배지 | 촬영 버튼 | 고객 메시지(고정 문구) |
| --- | --- | --- | --- |
| 연결 정상 | 연결됨 | 활성 | (메시지 없음) |
| 카메라 미연결 | 연결 필요 | 비활성 | `카메라 연결을 확인해 주세요.` |
| 촬영 기능 사용 불가(권한/드라이버) | 사용 불가 | 비활성 | `촬영을 준비 중입니다. 잠시만 기다려 주세요.` |
| 일시 오류(복구 시도 중) | 오류 | 비활성 | `촬영을 준비 중입니다. 잠시만 기다려 주세요.` |
| 지속 오류(관리자 조치 필요) | 오류 | 비활성 | `현재 촬영을 사용할 수 없습니다. 관리자에게 문의해 주세요.` |

[Source: docs/prd.md#requirements]

### Admin 진단 패널(표시 + 액션)

- 표시 항목(최소):
  - IPC 연결 상태: `connected | disconnected | reconnecting`
  - 마지막 오류 요약(문자열)
  - `protocolVersion`, `requestId`, `correlationId`
  - `camera.getStatus` 결과: `connected`, `cameraModel`, `sessionDestination`
- 액션(최소 1개 이상):
  - `재연결/재시도`(예: Named Pipe 재연결 + `camera.getStatus` 재호출)
  - (선택) `사이드카 재시작`

[Source: docs/prd.md#requirements]  
[Source: docs/architecture/api-design-and-integration.md#get-camera-status]  
[Source: docs/architecture/component-architecture.md#boothy-camera-ipc-client-tauri-backend]

### Tauri Commands (스토리에 고정)

- `boothy_camera_get_status() -> CameraStatus`
  - 내부적으로 `camera.getStatus`를 호출하고, 실패 시에도 UI가 결정 가능한 형태로 반환한다(에러/상태 포함).
  - 타임아웃 1s, 실패 시 `ipcState=disconnected` + `lastError` 포함.
- `boothy_camera_reconnect() -> { ok: boolean, attempts: number, lastError?: string }`
  - 최대 3회, backoff(예: 250ms/500ms/1000ms), 총 3s 이내.
  - 성공/실패 여부만 반환하고 상세 로그는 로그 파일로 기록.
- (선택) `boothy_camera_restart_sidecar() -> { ok: boolean, lastError?: string }`
  - sidecar 종료 → 재시작 → 재연결 시도(총 5s 이내).

[Source: docs/architecture/source-tree.md#integration-guidelines]  
[Source: docs/architecture/api-design-and-integration.md#get-camera-status]  
[Source: docs/architecture/component-architecture.md#boothy-camera-ipc-client-tauri-backend]

## Tasks / Subtasks

- [x] Task 1: UX/게이팅 범위 확정 (AC: 1, 2, 3, 4, 6)
  - [x] customer 모드에서 보여줄 최소 상태(연결/오류)와 **고정 메시지 문구**를 표로 확정한다(한국어/고객 안전, 기술 정보 금지).
    [Source: docs/prd.md#requirements]
  - [x] admin 모드에서 노출할 진단 패널(또는 기존 admin surface 확장) 위치를 확정한다.
    [Source: docs/prd.md#modifiednew-screens-and-views]  
    [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]

- [x] Task 2: Backend - 카메라 상태 조회 및 복구용 Tauri command 설계/추가 (AC: 1, 3, 4, 6)
  - [x] IPC request/response 매칭(대기/타임아웃/에러 매핑)이 미완이라면 우선 안정화하여 `camera.getStatus`를 신뢰성 있게 호출 가능하게 만든다.
    [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]  
    [Source: docs/architecture/component-architecture.md#boothy-camera-ipc-client-tauri-backend]
  - [x] `camera.getStatus` 결과를 반환하는 Tauri command를 추가한다(명명은 `docs/architecture/source-tree.md` 규칙 준수): `boothy_camera_get_status`.
    [Source: docs/architecture/source-tree.md#integration-guidelines]  
    [Source: docs/architecture/api-design-and-integration.md#get-camera-status]
  - [x] 복구 액션을 위한 Tauri command를 최소 1개 이상 추가한다(예: `boothy_camera_reconnect`, `boothy_camera_restart_sidecar` 중 1개 이상). 호출은 타임아웃/재시도를 포함하고, 실패해도 앱이 크래시/블로킹되지 않아야 한다.
    [Source: docs/architecture/component-architecture.md#boothy-camera-ipc-client-tauri-backend]

- [x] Task 3: UI - camera status + admin diagnostics 패널 구현 (AC: 1, 2, 3, 4, 6)
  - [x] customer 모드에서 카메라 상태를 최소 UI로 표시하고(연결/오류), 촬영 불가 시 고객 안전 메시지를 표시한다.
    [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]
  - [x] admin 모드에서 진단 정보를 표시하고, 복구 버튼(reconnect/retry 또는 restart sidecar)을 제공한다.
    [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]
  - [x] `boothy-mode-changed` 이벤트 기반으로 UI hiding 정책을 일관되게 적용한다.
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]  
    [Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend--react-ui]

- [x] Task 4: 로깅/진단 일관성(에러 + correlationId) (AC: 2, 3, 4)
  - [x] 에러 발생 시 customer 모드 메시지는 한국어/고객 안전 문구로 제한하고, admin 모드에는 `correlationId`를 포함한 진단 정보를 표시한다.
    [Source: docs/prd.md#requirements]
  - [x] 로그 파일 위치를 Dev Notes에 명시하고, 현장 디버깅에 필요한 최소 정보를 제공한다.
    [Source: docs/architecture/development-environment.md#local-setup-mvp]

- [ ] Task 5: 테스트/검증 (AC: 1, 2, 3, 4, 5, 6)
  - [x] Backend(IPC) 단위/통합 테스트: `camera.getStatus` 응답 매칭, 타임아웃/재시도, sidecar 재시작 내성.
    [Source: docs/architecture/testing-strategy.md#integration-tests]
  - [ ] UI 테스트(스모크): customer/admin 숨김 정책 + 상태 표시(최소) 확인.
    [Source: docs/architecture/testing-strategy.md#integration-with-existing-tests]
  - [ ] 오프라인 정책 검증: 진단/복구 플로우에서 네트워크 호출이 발생하지 않음을 확인.
    [Source: docs/prd.md#offline--no-account-policy-mvp]
  - [ ] 수동 검증 시나리오: 미연결/오류 → admin 복구 동작 → 정상 연결/상태 복귀, 그리고 기존 browse/edit/export 비차단 확인.
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]

## Dev Notes

### Previous Story / Related Context

- 본 스토리는 Epic 4의 (Optional) 4.2로, Story 4.1(실카메라 E2E)에서 발생하는 현장 장애를 **빠르게 복구/진단**하는 보완 작업이다.
- `CameraIpcClient.send_request()`의 응답 대기/매칭이 TODO일 수 있으므로, `camera.getStatus`/복구 액션을 안정적으로 제공하려면 request/response 채널 안정화가 선행되어야 한다.

[Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]

### IPC Contract (Boothy ↔ Sidecar)

- IPC transport: Windows Named Pipe `\\\\.\\pipe\\boothy_camera_sidecar`
- Envelope: `protocolVersion`, `messageType`, `requestId`, `correlationId`, `method`, `payload`, `error`
- 사이드카 메소드:
  - `camera.getStatus` (진단/상태 표기)
  - `camera.setSessionDestination` (세션 `Raw/` 설정, 복구 동작에도 사용 가능)
  - (선택) `system.shutdown` (sidecar 재시작 복구에 사용 가능)

[Source: docs/architecture/component-architecture.md#camera-sidecar-service-cnet-headless]  
[Source: docs/architecture/api-design-and-integration.md#tauri-backend--camera-sidecar-named-pipe-rpc]

### UI Gating / Admin Diagnostics

- customer/admin 모드 전환은 Mode/Auth 컴포넌트를 따르고, customer 모드에서는 고급 기능을 “숨김” 처리한다.
- customer 모드 에러 문구는 한국어 고객 안전 메시지로 제한하고, admin 모드에서는 `correlationId` 등 상세 진단을 제공한다.

[Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend--react-ui]  
[Source: docs/architecture/security-integration.md#enhancement-security-requirements]

### File Locations (Project Structure)

- Tauri backend(IPC/복구/상태): `apps/boothy/src-tauri/src/camera/`
- React UI(상태 배지/진단 패널): `apps/boothy/src/`
- IPC 모델(테스트 원본): `apps/boothy/src-tauri/src/camera/ipc_models.rs` ↔ `apps/camera-sidecar/IPC/IpcMessage.cs`

[Source: docs/architecture/source-tree.md#new-file-organization]  
[Source: docs/architecture/source-tree.md#integration-guidelines]

### Diagnostics / Logs

- Boothy 로그: `%APPDATA%\\Boothy\\logs\\boothy.log`
- Sidecar 로그: `%APPDATA%\\Boothy\\logs\\camera-sidecar.log`

[Source: docs/architecture/development-environment.md#local-setup-mvp]

## Testing

- Backend: IPC 요청/응답 매칭, 타임아웃/재시도, sidecar 재시작 내성(테스트 포함)
- UI: customer/admin 숨김 정책 + 최소 상태 표시 스모크
- Manual gate: 미연결/오류 → admin 복구 동작 → 정상 연결/상태 복귀, 그리고 기존 browse/edit/export 비차단 확인

[Source: docs/architecture/testing-strategy.md#new-testing-requirements]  
[Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]

## Change Log

| Date       | Version | Description                                   | Author |
| ---------- | ------- | --------------------------------------------- | ------ |
| 2026-01-24 | 0.1     | Create story 4.2 (Draft).                     | Bob (SM) |
| 2026-01-24 | 0.2     | Validate fixes: anchors + customer 메시지/명령 스펙 보강. | Sarah (PO) |
| 2026-01-24 | 0.3     | Mark Approved + AC5(오프라인) 테스트 범위 보강. | Sarah (PO) |
| 2026-01-24 | 0.4     | Implement camera diagnostics + reconnect UI/IPC. | James (Dev) |

## Dev Agent Record

### Agent Model Used

GPT-5.2

### Debug Log References

None

### Completion Notes List

- IPC diagnostics snapshot + request/response correlation added for camera status.
- Admin diagnostics panel + reconnect flow wired; customer status messaging added.
- `boothy_camera_get_status`/`boothy_camera_reconnect` + capture trigger available for UI.

### File List

- apps/boothy/src-tauri/src/camera/ipc_client.rs
- apps/boothy/src-tauri/src/main.rs
- apps/boothy/src/App.tsx
- apps/boothy/src/components/panel/CameraControlsPanel.tsx
- apps/boothy/src/components/panel/MainLibrary.tsx
- apps/boothy/src/components/ui/AppProperties.tsx
- apps/boothy/src/tauriMock.ts
- apps/camera-sidecar/Program.cs
- apps/camera-sidecar/Camera/MockCameraController.cs
- apps/camera-sidecar/Camera/ICameraController.cs
- apps/camera-sidecar/Camera/RealCameraController.cs

## QA Results

### Review Date: 2026-01-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

전반적으로 구현은 요구사항 방향과 일치하며 IPC/UI wiring은 일관적입니다. 다만 테스트 미완료와 reconnect 상태가 연결 상태로 복구되지 않는 가능성이 있어 릴리즈 전 보완이 필요합니다.

### Refactoring Performed

- 없음

### Compliance Check

- Coding Standards: PASS (코드 스타일/명명 규칙 준수, IPC 모델 분리 유지)
- Project Structure: PASS (camera/sidecar/ui 위치 가이드 준수)
- Testing Strategy: CONCERNS (UI/오프라인/수동 테스트 미완료)
- All ACs Met: CONCERNS (AC5 오프라인 검증 미실행, 나머지는 코드 리뷰 기준으로만 확인)

### Improvements Checklist

- [ ] start_sidecar가 이미 연결된 경우 ipc_state를 connected로 복구
- [ ] AC2/5/6 대상 UI 스모크 및 수동 테스트 수행/기록
- [ ] 오프라인(스토리지 차단) 시나리오 재연결/진단 동작 수동 검증

### Security Review

특이사항 없음. Admin 전용 UI gating은 확인되나, 백엔드 명령은 UI에서만 제한됨(로컬 앱 맥락상 허용 범위).

### Performance Considerations

5초 주기 상태 폴링 수준으로 부담 낮음. 재연결 시 단기 backoff만 수행.

### Files Modified During Review

- 없음

### Gate Status

Gate: CONCERNS – `docs/qa/gates/4.2-admin-camera-diagnostics-reconnect-workflows.yml`
Risk profile: 미작성
NFR assessment: 미작성

### Recommended Status

Changes Required - See unchecked items above
(Story owner decides final status)
