# Story 3.2: Critical Lockout Guardrails & Error Wiring

## Status

Approved

## Story

**As a** booth user,  
**I want** Boothy to safely block write operations when disk space is critically low,  
**so that** the booth avoids downtime and prevents data loss/corruption.

[Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#goal]
[Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]

## Acceptance Criteria

1. When storage health is **critical**, Boothy blocks booth-critical write actions (capture/transfer ingest/export) in customer mode with a customer-safe message.
2. While in critical lockout, Boothy preserves read-only access to already-imported photos (browsing/selection/viewing remains available).
3. Disk-full / low-space failures are wired through the existing error framework consistently (includes exercising the existing `DISK_FULL` path).
4. Background export work is prevented from starting (and any in-flight work is cooperatively paused/cancelled) while the app is in critical lockout, to avoid additional disk writes.
5. When disk space returns above threshold, Boothy clears lockout/warnings automatically and the booth workflow resumes without restarting the app.
6. Session folder contract and export output locations remain unchanged, and no new network dependencies are introduced.

[Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
[Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
[Source: docs/prd.md#modifiednew-screens-and-views]

## Tasks / Subtasks

- [ ] Task 1: Confirm dependencies and lockout policy (AC: 1-6)
  - [ ] Treat Story 3.1 as a hard dependency for the storage health signal/state (monitor + `boothy-storage-health` event + thresholds/config).
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#integration-approach]
  - [ ] Define the authoritative lockout condition (critical threshold only) and what is blocked vs. still allowed (read-only browsing of existing photos).
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
    [Source: docs/architecture/coding-standards.md#critical-integration-rules]
  - [ ] Confirm the error code mapping for low-space conditions:
    - Critical (pre-emptive) lockout should use an existing, UI-supported error path consistently
    - Actual disk-write failures should exercise the existing `DISK_FULL` path end-to-end
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

- [ ] Task 2: Backend guardrails for write operations (AC: 1, 3, 4, 6)
  - [ ] Add a single shared "storage critical guard" that can be called by all write entrypoints (capture, ingest handling, export start, background export worker).
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  - [ ] On critical lockout, return a consistent error code/message via the existing error framework and ensure the UI receives a customer-safe message plus admin diagnostics where available.
    [Source: docs/prd.md#modifiednew-screens-and-views]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  - [ ] Ensure guardrails are enforced in the backend (not only via UI disablement) so any invoked command still fails safely while critical.
    [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]

- [ ] Task 3: Export pipeline + queue behavior under critical lockout (AC: 1, 4, 5, 6)
  - [ ] Prevent `boothy_handle_export_decision(...)` from starting export work while critical, and surface the error consistently in the existing export UI error paths.
    [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#tasks--subtasks]
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [ ] Pause/cancel background export work while critical; do not enqueue new background exports during lockout:
    - If a background export is already in-flight, it must stop cooperatively at a safe boundary (no partial/corrupt outputs) and surface a consistent lockout state/error.
    - Items that were queued but not started should remain pending (not dropped) and resume automatically when status returns to healthy.
    [Source: docs/stories/2.3.background-export-queue-and-file-monitoring.md#tasks--subtasks]
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [ ] When status returns healthy, allow background/manual export to resume without restarting the app.
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]

- [ ] Task 4: Transfer/ingest behavior under critical lockout (AC: 1, 2, 3, 5)
  - [ ] Block ingest handling when critical (e.g., ignore or safely reject `boothy-photo-transferred` processing paths) while keeping the library usable for existing photos.
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
    [Source: docs/stories/2.3.background-export-queue-and-file-monitoring.md#story]
  - [ ] Ensure transfer/import failures related to low disk are surfaced as customer-safe errors and (in admin mode) include diagnostic context.
    [Source: docs/prd.md#modifiednew-screens-and-views]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

- [ ] Task 5: Frontend customer-mode lockout UX wiring (AC: 1, 2, 5)
  - [ ] Listen for the storage health event (from Story 3.1) and set a dedicated lockout state that disables customer-mode write actions (capture/export) without breaking browsing.
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#integration-approach]
    [Source: docs/frontend-architecture.md#ui-gating-rules]
  - [ ] Display a kiosk-safe critical lockout message in customer mode (exact copy): `디스크 공간이 부족합니다. 직원에게 문의해 주세요.`
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [ ] Verify that when storage returns above threshold, the lockout UI automatically clears and write actions become available again.
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]

- [ ] Task 6: Tests + validation scenarios (AC: 1-6)
  - [ ] Unit (backend): add tests for the shared guard logic and error mapping for "critical" vs "healthy/unknown".
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
  - [ ] Manual (MVP gate): simulate critical threshold (via settings) and verify capture/import/export are blocked, browsing remains available, and recovery clears without restart.
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#definition-of-done]
  - [ ] Regression: verify normal booth flow remains unchanged when disk is healthy (session start -> import/new photo detection -> preset apply -> export).
    [Source: docs/architecture/testing-strategy.md#regression-testing]
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#definition-of-done]

## Dev Notes

### Previous Story Insights

- This story assumes Story 3.1 has introduced the storage health monitor, thresholds/config, and a UI-facing event (e.g., `boothy-storage-health`). If Story 3.1 is not complete, this story is blocked on that integration surface.
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#integration-approach]
- Boothy already has patterns for "lockout but keep app usable" (timeline T-0 lockout) and for export pipeline entrypoints (manual decision + background export). Reuse those patterns rather than adding parallel mechanisms.
  [Source: docs/stories/2.2.t-0-lockout-application-reset-admin-settings.md#story]
  [Source: docs/stories/2.3.background-export-queue-and-file-monitoring.md#story]
  [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#story]

### Data Models

- No new session folder schema is allowed; inputs remain `{session}/Raw/` and outputs remain `{session}/Jpg/`.
  [Source: docs/architecture/component-architecture.md#component-interaction-diagram]
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#compatibility-requirements]
- Thresholds/config are stored in existing AppData settings (`settings.json`, `boothy.*` namespace) and must be append-only/backward compatible.
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#integration-approach]
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#compatibility-requirements]

### API / Events

- Follow the established in-app API boundary: UI invokes Tauri commands; backend emits Tauri events.
  [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]
- Naming conventions: `boothy_*` for commands and `boothy-*` for events.
  [Source: docs/architecture/source-tree.md#integration-guidelines]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
- Storage health event contract is expected to be emitted from the backend to drive UI state changes.
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#integration-approach]
- Story 3.1 defines the storage health status classification and event name; Story 3.2 relies on that contract:
  - Event name: `boothy-storage-health`
  - Status classification: `healthy | warning | critical | unknown`
  - Payload should include status + bytes (e.g., free/total) to support admin diagnostics later (Story 3.3)
  [Source: docs/stories/3.1.storage-health-monitor-backend-ui-status-surface.md#tasks--subtasks]

### Component / UX Notes

- Customer mode must remain kiosk-safe: show a minimal message and avoid exposing technical details; admin mode can show diagnostics (full diagnostics UI is Story 3.3).
  [Source: docs/frontend-architecture.md#key-principles]
  [Source: docs/prd.md#modifiednew-screens-and-views]
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
- Customer-safe critical lockout copy (customer mode): `디스크 공간이 부족합니다. 직원에게 문의해 주세요.`
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
- Error/recovery states must include low disk space and use customer-friendly messaging with admin diagnostics.
  [Source: docs/prd.md#modifiednew-screens-and-views]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### File Locations (Guidance)

- React UI: `apps/boothy/src/`
- Tauri backend: `apps/boothy/src-tauri/src/`
  [Source: docs/architecture/source-tree.md#new-file-organization]
- Suggested touchpoints (verify in codebase; do not introduce parallel pipelines):
  - Backend orchestration/commands: `apps/boothy/src-tauri/src/main.rs` (export decision, photo-transfer handling, event wiring).
    [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#tasks--subtasks]
    [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#dev-agent-record]
  - Export pipeline + background queue: `apps/boothy/src-tauri/src/session/export.rs` and `apps/boothy/src-tauri/src/session/export_queue.rs`.
    [Source: docs/stories/2.3.background-export-queue-and-file-monitoring.md#dev-notes]
    [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#dev-agent-record]
  - Frontend event listeners + lockout gating: `apps/boothy/src/App.tsx`.
    [Source: docs/stories/2.2.t-0-lockout-application-reset-admin-settings.md#story]
    [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#tasks--subtasks]
  - Boothy export progress/error UI plumbing: `apps/boothy/src/hooks/useExportProgress.tsx`.
    [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#dev-agent-record]

### Testing

- Prefer scenario-based manual validation for MVP gate, supplemented by focused unit tests for pure logic (guards, state transitions, error mapping).
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

### Technical Constraints

- Offline-first policy: no new network calls/dependencies.
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  [Source: docs/prd.md#technical-constraints-and-integration-requirements]
- Treat IO errors from disk-stat reads as "unknown" (warn/admin-diagnostic) rather than hard lockout unless critical is confirmed.
  [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#risk-mitigation]
- Edge cases to cover:
  - Critical status flips while background export is running: pause/cancel cooperatively and surface a consistent user-facing state.
  - Critical status flips while transfer event arrives: do not proceed with any writes; preserve browsing for already-imported photos.
    [Source: docs/prd/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]

### Project Structure Notes

- `docs/architecture/unified-project-structure.md` is not present in this repo; use `docs/architecture/source-tree.md` for file placement guidance.
  [Source: docs/architecture/source-tree.md#new-file-organization]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-22 | 0.1 | Initial draft created from Epic 3 + architecture/testing docs | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

- [ ] TBD

### File List

#### New Files Created

- [ ] TBD

#### Modified Files

- [ ] TBD

## QA Results

TBD
