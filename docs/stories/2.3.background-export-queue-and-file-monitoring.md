# Story 2.3: Background Export Queue & File Monitoring

## Status

In Progress

## Story

**As a** booth user,  
**I want** photos to be automatically processed in the background,  
**so that** final export is fast and I don't wait unnecessarily.

[Source: docs/prd-session-timeline-smart-export.md#story-23-background-export-queue--file-monitoring]

## Acceptance Criteria

1. When Story 1.1's photo detection fires (new photo added to session folder), background export queue receives the event.
2. Background export starts processing within 5 seconds of receiving the photo detection event.
3. Background export uses identical pipeline as manual export (output files byte-identical for same input).
4. Exported files written to existing `{session_folder}/Jpg/` folder.
5. Session metadata correctly tracks which photos have been background-exported.
6. Background processing does not cause UI frame drops or input lag during user interaction.
7. If background export fails, error is logged and does not crash app.
8. Failed background exports are retried during manual export (not silently skipped).

[Source: docs/prd-session-timeline-smart-export.md#story-23-background-export-queue--file-monitoring]

## Tasks / Subtasks

- [x] Task 1: Wire background export enqueue to new-photo detection (AC: 1, 2)
  - [x] Hook into the existing stable-file detection path and enqueue background exports for each confirmed new RAW file.
    [Source: docs/architecture/component-architecture.md#boothy-file-arrival-watcher-tauri-backend]
  - [x] Use `boothy-new-photo` as the contract for the 'new photo arrived' signal (at minimum `path`; preserve/pass-through any additional fields like `correlationId` for logging) and ensure the enqueue happens at the same point the event is emitted (avoid double watchers).
    [Source: docs/stories/1.1.booth-app-foundation-session-mode-gating.md#tasks--subtasks]
    [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]
  - [x] Ensure enqueue occurs after preset snapshot application has been written for that photo (so background export respects the preset-at-capture contract).
    [Source: docs/architecture/component-architecture.md#boothy-preset-assignment-service-tauri-backend]
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyperimagestate-stored-in-rapidraw-rrdata]

- [x] Task 2: Implement single-worker background export queue (tokio) (AC: 2, 6, 7)
  - [x] Create a tokio channel-based queue that processes exactly one photo at a time (no parallel exports in this story).
    [Source: docs/prd-session-timeline-smart-export.md#story-23-background-export-queue--file-monitoring]
    [Source: docs/architecture/tech-stack.md#existing-technology-stack]
  - [x] Run export work off the UI thread (e.g., `spawn_blocking` or existing pipeline worker mechanism) and keep the UI responsive (NFR4).
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
    [Source: docs/architecture/tech-stack.md#existing-technology-stack]
  - [x] Best-effort 'lower priority' execution: ensure the queue yields to interactive operations by enforcing `max_concurrent_exports=1` and avoiding contention; do not introduce new dependencies.
    [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]

- [x] Task 3: Reuse manual export pipeline and write outputs to `Jpg/` (AC: 3, 4)
  - [x] Background export MUST reuse the exact same export pipeline as manual export to guarantee byte-identical outputs; if there is no shared internal function yet, extract one (e.g., `export_photo()`) and have both manual export and background export call it.
    [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]
  - [x] Export destination is the existing session folder `Jpg/` (no new folders).
    [Source: docs/architecture/component-architecture.md#component-interaction-diagram]
    [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
  - [x] Ensure exported results reflect per-photo preset snapshots persisted at ingest time (do not apply 'current preset' retroactively).
    [Source: docs/architecture/component-architecture.md#boothy-preset-assignment-service-tauri-backend]
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyperimagestate-stored-in-rapidraw-rrdata]

- [x] Task 4: Track background export completion in session metadata JSON (AC: 5, 8)
  - [x] Introduce or extend a session-level metadata file in the session root (preferred: `boothy.session.json`) to track per-photo `background_export_completed` and timestamps.
    [Source: docs/architecture/data-models-and-schema-changes.md#boothysession-folder-backed-session]
    [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]
  - [x] Keep the metadata schema append-only (only add new fields; do not remove/rename existing fields) and backward compatible; include a `schemaVersion` if the file is introduced.
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
    [Source: docs/architecture/data-models-and-schema-changes.md#schema-integration-strategy]
  - [x] Ensure metadata remains valid JSON across app restarts and partial failures (atomic write/update pattern).
    [Source: docs/prd-session-timeline-smart-export.md#story-23-background-export-queue--file-monitoring]
  - [x] Track enough state to support AC8 (retry-on-manual-export) without ambiguity: distinguish at least `completed` vs `failed`, and record `attemptCount` + `lastAttemptAt` + `lastError` (code/message/context). Do not treat "attempted" as "completed".
    [Source: docs/prd-session-timeline-smart-export.md#story-23-background-export-queue--file-monitoring]

- [x] Task 5: Add background export logging + error handling (AC: 7)
  - [x] Log start/complete/fail for each background export with timestamps and correlation IDs linking detection ??export (prefer using the existing detection correlationId when present; otherwise generate one).
    [Source: docs/architecture/coding-standards.md#critical-integration-rules]
    [Source: docs/prd-session-timeline-smart-export.md#deployment-and-operations]
  - [x] Represent errors as structured error code + message + context; failures must not crash the app.
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
    [Source: docs/architecture/coding-standards.md#critical-integration-rules]

- [x] Task 6: Cooperative cancellation and manual-export retry semantics (AC: 8, 6)
  - [x] If a user triggers manual export while a background export is running, cancel/stop the background export cooperatively before starting manual export (avoid racing two exports against the same input/output paths).
    [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]
  - [x] Manual export must retry any photos whose background export previously failed (do not silently skip on "background attempted" state; only skip when background export is actually completed).
    [Source: docs/prd-session-timeline-smart-export.md#story-23-background-export-queue--file-monitoring]

- [ ] Task 7: Tests + validation scenarios (AC: 1-8)
  - [x] Unit: add Rust tests for session metadata read/write and backward-compatible update behavior (including failure states and atomic write pattern).
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
  - [x] Unit: add Rust tests for queue behavior (single concurrency, cancel signal, and enqueue dedupe if applicable).
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
  - [ ] Manual (MVP gate): verify new-photo ??background export within 5s; verify app remains responsive; verify outputs land in `Jpg/`; verify failures do not crash and are logged.
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  - [ ] Regression: verify existing manual export output remains unchanged and preset assignments still apply per-photo.
    [Source: docs/architecture/testing-strategy.md#regression-testing]
    [Source: docs/prd-session-timeline-smart-export.md#story-23-background-export-queue--file-monitoring]

## Dev Notes

### Previous Story Insights

- Photo detection + stabilization already exists (Story 1.1) and emits `boothy-new-photo` when a new RAW file is confirmed stable; this story must build on that single source of truth (do not add another watcher).
  [Source: docs/stories/1.1.booth-app-foundation-session-mode-gating.md#tasks--subtasks]
  [Source: docs/architecture/component-architecture.md#boothy-file-arrival-watcher-tauri-backend]
- Session folder contract is `{session}/Raw/` for inputs and `{session}/Jpg/` for outputs; this story must not change the session folder structure.
  [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
  [Source: docs/architecture/component-architecture.md#component-interaction-diagram]

### Data Models

- Per-photo preset snapshots are persisted in RapidRAW `.rrdata` sidecars (append-only). Background export should rely on that persisted state so it reflects the preset at capture time.
  [Source: docs/architecture/data-models-and-schema-changes.md#boothyperimagestate-stored-in-rapidraw-rrdata]
- Session-level metadata may be stored as `boothy.session.json` at the session root (optional per architecture). This story introduces/extends it specifically for background export completion state.
  [Source: docs/architecture/data-models-and-schema-changes.md#boothysession-folder-backed-session]
  [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]

### API Specifications

- No new user-facing UI commands are required for 'start background export'; it is driven by backend detection events and runs automatically.
  [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]
- Follow the established in-app command/event approach and correlation ID logging guidance for observability.
  [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]
  [Source: docs/architecture/coding-standards.md#critical-integration-rules]

### Component Specifications

- Background export should run as a tokio background task and must not block UI rendering or input.
  [Source: docs/architecture/tech-stack.md#existing-technology-stack]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### File Locations (Guidance)

- Product code lives under `apps/boothy/` with backend modules under `apps/boothy/src-tauri/src/`.
  [Source: docs/architecture/source-tree.md#new-file-organization]
- The PRD suggests placing the background export queue in `src-tauri/src/session/export_queue.rs`; follow that shape unless the existing codebase already has a more appropriate export module location.
  [Source: docs/prd-session-timeline-smart-export.md#code-organization-and-standards]

### Testing

- Prefer scenario-based manual validation as the MVP gate, plus focused unit tests for pure logic (queue/state tracking).
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

### Technical Constraints

- Keep background work off the UI thread, maintain offline-first behavior, and do not introduce new network dependencies.
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  [Source: docs/prd/technical-constraints-and-integration-requirements.md#existing-technology-stack]

### Project Structure Notes

- `docs/architecture/unified-project-structure.md` is not present in this repo; use `docs/architecture/source-tree.md` as the project structure source for this story.
  [Source: docs/architecture/source-tree.md#new-file-organization]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-15 | 0.1 | Initial draft created from Epic 2 PRD + architecture | Scrum Master (Bob) |
| 2026-01-15 | 0.2 | Clarify enqueue contract, export pipeline reuse, and metadata failure tracking | Product Owner (Sarah) |
| 2026-01-16 | 0.3 | Implement background export queue, session metadata tracking, cancellation, and unit tests | Dev (James) |

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex CLI)

### Debug Log References

- `cargo test` (apps/boothy/src-tauri)

### Completion Notes List

- [x] Background export queue enqueued from boothy-new-photo after preset snapshot.
- [x] Shared export pipeline via `export_photo` with outputs written to session `Jpg/`.
- [x] Session metadata tracks background export completion, attempts, and errors.
- [x] Manual export cancels/pauses background export to avoid path conflicts.
- [ ] Manual MVP gate and regression export validation not run.

### File List

#### New Files Created

- [x] apps/boothy/src-tauri/src/session/export_queue.rs
- [x] apps/boothy/src-tauri/src/session/metadata.rs

#### Modified Files

- [x] apps/boothy/src-tauri/src/main.rs
- [x] apps/boothy/src-tauri/src/ingest/file_watcher.rs
- [x] apps/boothy/src-tauri/src/file_management.rs
- [x] apps/boothy/src-tauri/src/session/mod.rs
- [x] apps/boothy/src-tauri/src/session/timer.rs
- [x] docs/stories/2.3.background-export-queue-and-file-monitoring.md

## QA Results

TBD

