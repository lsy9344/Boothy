# Story 3.4: Admin Guided Cleanup: Safe Old Session Deletion

## Status

Done

## Story

**As a** booth admin,  
**I want** to safely delete old session folders from the session root with strict confirmation,  
**so that** I can recover disk space without risking the active session or deleting outside Boothy's storage boundary.

[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]

## Acceptance Criteria

1. Given admin mode is unlocked, the admin can select one or more old sessions under the session root for deletion, and the currently active session is not deletable.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
2. Given a delete action is initiated, the UI requires explicit destructive confirmation (e.g., type-to-confirm) before deletion starts.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
3. Given a delete request is received, the backend enforces strict path safety: deletions are constrained to the configured session root and must not allow traversal outside that root.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#integration-approach]
   [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
4. Given deletion completes (success or failure), admin mode shows actionable diagnostics; the app does not crash and customer mode remains kiosk-safe.
   [Source: docs/prd.md#modifiednew-screens-and-views]
   [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
5. No new network dependencies are introduced for cleanup; offline-first policy remains intact.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
   [Source: docs/architecture/security-integration.md#compliance-requirements]

## Tasks / Subtasks

- [x] Task 1: Confirm dependencies and UX surface location (AC: 1, 2, 4)
  - [x] Implement this story as an extension of the Epic 3 admin diagnostics surface (Story 3.3); do not introduce customer-mode UI beyond kiosk-safe messaging.
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
    [Source: docs/frontend-architecture.md#ui-gating-rules]
  - [x] Ensure admin unlock is the gate for all cleanup actions (no cleanup access in customer mode).
    [Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend--react-ui]
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]

- [x] Task 2: Add backend API for session enumeration (admin cleanup list) (AC: 1)
  - [x] Define a new `boothy_*` Tauri command to return a list of candidate session folders under `boothy.sessionsRoot` (folder name + path; optional: last modified + size).
    [Source: docs/architecture/source-tree.md#integration-guidelines]
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
  - [x] Ensure enumeration is constrained to the session root and is robust to unreadable folders (report in admin diagnostics, don't crash).
    [Source: docs/architecture/security-integration.md#security-testing]
    [Source: docs/prd.md#modifiednew-screens-and-views]

- [x] Task 3: Add backend API for safe deletion (admin-only) (AC: 1, 3, 4, 5)
  - [x] Define a new `boothy_*` Tauri command to delete selected session folders by session folder name(s) (not arbitrary paths).
    [Source: docs/architecture/source-tree.md#integration-guidelines]
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
  - [x] Enforce path safety rules in backend:
    - Canonicalize targets and require they are direct children of the session root.
    - Reject any path that escapes the session root (no traversal), and never follow user-provided absolute paths.
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
  - [x] Protect the currently active session from deletion (backend check), even if it is included by mistake in the request.
    [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [x] Ensure heavy filesystem operations do not block the UI event loop (use background execution patterns).
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
    [Source: docs/architecture/tech-stack.md#existing-technology-stack]

- [x] Task 4: Build admin UI for selecting and confirming session deletion (AC: 1, 2, 4)
  - [x] Add an admin-only "Cleanup" surface that lists candidate sessions and allows multi-select (or single-select) deletion.
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
    [Source: docs/frontend-architecture.md#core-views-mvp]
  - [x] Ensure the active session is clearly identified and cannot be selected for deletion (e.g., excluded from the list or shown disabled with an "Active" label).
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [x] Add a destructive confirmation modal that requires explicit user intent (type-to-confirm), and clearly warns that deletion is permanent.
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [x] On success/failure, show admin diagnostics; ensure any customer-facing messaging remains kiosk-safe and non-technical.
    [Source: docs/prd.md#modifiednew-screens-and-views]
    [Source: docs/frontend-architecture.md#key-principles]

- [x] Task 5: Validate end-to-end behavior and add focused tests (AC: 1, 2, 3, 4, 5)
  - [x] Add Rust unit tests for path canonicalization / "must be under session root" enforcement and active-session protection logic.
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
    [Source: docs/architecture/security-integration.md#security-testing]
  - [x] Add at least one UI test (where existing patterns exist) for confirmation gating (delete action cannot proceed without explicit confirmation).
    [Source: docs/architecture/testing-strategy.md#new-testing-requirements]
  - [x] Manual MVP gate scenarios:
    - Delete an old session folder (non-active) and verify it is removed and the app remains stable.
    - Attempt to delete the active session and verify it is blocked.
    - Attempt a traversal-like input and verify backend rejects it.
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
    [Source: docs/architecture/security-integration.md#security-testing]

## Dev Notes

### Context / Scope

- This story is being prepared out-of-sequence by request. Epic 3's defined dependency order is 3.1 -> 3.2 -> 3.3 -> 3.4; implement 3.4 only after the required admin diagnostics surface exists.
  [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
- Cleanup must not break the session storage contract: Boothy's storage boundary is the session root under `%USERPROFILE%\\Pictures\\dabi_shoot\\<session>\\{Raw,Jpg}`.
  [Source: docs/architecture/component-architecture.md#component-interaction-diagram]
  [Source: docs/architecture/security-integration.md#enhancement-security-requirements]

### Data Models / Settings

- Session root is configured via `boothy.sessionsRoot` in AppData `settings.json` (MVP default `%USERPROFILE%\\Pictures\\dabi_shoot`).
  [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]

### API / Command Naming

- New UI->backend commands must follow the `boothy_*` naming convention; events (if needed) use `boothy-*`.
  [Source: docs/architecture/source-tree.md#integration-guidelines]
  [Source: docs/architecture/api-design-and-integration.md#new-api-endpoints]

### Security / Path Safety (Non-Negotiable)

- All delete actions must be constrained to the session root and reject traversal / escaping paths after canonicalization.
  [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
- Customer mode should not expose technical details; admin mode can show detailed diagnostics.
  [Source: docs/prd.md#modifiednew-screens-and-views]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### File Locations (Guidance)

- Product code lives under:
  - React UI: `apps/boothy/src/`
  - Tauri backend: `apps/boothy/src-tauri/src/`
  [Source: docs/architecture/source-tree.md#new-file-organization]
- Session-related backend code should align with the session module boundaries (`session/*`) rather than introducing new ad-hoc locations.
  [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]

### Testing

- MVP emphasizes scenario-based manual validation; add focused unit tests for high-risk safety logic (path safety + active-session protection).
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-22 | 0.1 | Initial draft for Epic 3.4 (admin cleanup safe deletion) | Scrum Master (Bob) |
| 2026-01-22 | 0.2 | Fix sources/typography; align Testing heading; clarify active-session deletion UX; set Status to Approved | Product Owner (Sarah) |
| 2026-01-24 | 0.3 | Preserve cleanup success notification so deletion summary is visible | Dev (James) |

## Dev Agent Record

### Agent Model Used

GPT-5

### Debug Log References

- npm test (apps/boothy)
- cargo test cleanup (apps/boothy/src-tauri); full cargo test timed out
- deno lint (command not found: deno)
- deno test -A (command not found: deno)

### Completion Notes List

- [x] Added admin-only cleanup list + delete commands with path safety and active-session protection.
- [x] Built cleanup UI with multi-select, active-session lockout, and type-to-confirm flow.
- [x] Added focused Rust and UI tests for safety and confirmation gating.
- [x] Ensured cleanup deletion summary stays visible (auto-clears) after list refresh.

### File List

#### New Files Created

- [x] apps/boothy/src-tauri/src/session/cleanup.rs
- [x] apps/boothy/src/components/modals/__tests__/ConfirmModal.test.tsx

#### Modified Files

- [x] apps/boothy/src-tauri/src/main.rs
- [x] apps/boothy/src-tauri/src/error.rs
- [x] apps/boothy/src-tauri/src/session/mod.rs
- [x] apps/boothy/src/components/panel/SettingsPanel.tsx
- [x] apps/boothy/src/components/ui/AppProperties.tsx
- [x] apps/boothy/src/components/modals/ConfirmModal.tsx
- [x] apps/boothy/src/tauriMock.ts

## QA Results

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

전반적으로 구조가 명확하며 백엔드/프론트 분리가 적절합니다. 삭제/열거 모두 `spawn_blocking`으로 UI 이벤트 루프를 보호했고, 경로 안전성 검증과 활성 세션 보호 로직이 명확합니다. 다만 스토리 상태가 "Ready for Review"로 표기되어 있어 요구 프리리퀴짓("Review")과 불일치합니다(프로세스 이슈).

- 검토한 테스트:
  - Rust: `apps/boothy/src-tauri/src/session/cleanup.rs` 내 5개 유닛 테스트
  - UI: `apps/boothy/src/components/modals/__tests__/ConfirmModal.test.tsx` 1개

### Requirements Traceability (Given/When/Then)

- **AC1** (Admin 모드에서 오래된 세션 선택, 활성 세션은 삭제 불가)
  - Given admin mode unlocked, When cleanup list is shown, Then active session은 선택 불가/삭제 불가.
  - **Test coverage:** `delete_sessions_skips_active`로 활성 세션 보호 확인. UI 선택/비활성 표시 자동 테스트는 없음.
- **AC2** (파괴적 확인: type-to-confirm)
  - Given delete action initiated, When confirm text 입력, Then 확인 전 삭제 불가.
  - **Test coverage:** `ConfirmModal` 테스트로 확인.
- **AC3** (세션 루트 밖 삭제 방지)
  - Given delete request, When path validation, Then session root 밖 접근 차단.
  - **Test coverage:** `validate_session_name_rejects_nested_paths`, `validate_session_name_rejects_parent_dir`, `resolve_session_dir_rejects_outside_root`.
- **AC4** (성공/실패 후 진단 표시, 앱 안정성)
  - Given deletion completes, When response handled, Then admin 진단 메시지 제공 및 앱 안정성 유지.
  - **Test coverage:** 자동 테스트 없음(수동 확인 필요).
- **AC5** (오프라인 유지, 네트워크 의존성 없음)
  - Given cleanup 구현, When wired, Then 네트워크 의존성 추가 없음.
  - **Test coverage:** 코드 리뷰 기반 확인.

### Refactoring Performed

없음.

### Compliance Check

- Coding Standards: PASS (boothy_* 네이밍, 백엔드 `spawn_blocking` 사용 등 준수)
- Project Structure: PASS (`docs/architecture/source-tree.md` 기준; unified-project-structure.md 미존재)
- Testing Strategy: CONCERNS (MVP 수동 게이트 시나리오 미수행)
- All ACs Met: CONCERNS (구현은 충족하나 수동 검증 미완)

### Improvements Checklist

- [ ] MVP 수동 게이트 시나리오 수행 (삭제 성공/실패/활성 세션/탐색 입력 차단)
- [ ] Admin cleanup UI 선택/진단 표시에 대한 최소 UI 테스트 추가

### Security Review

경로 검증(`canonicalize` + 세션명 단일 컴포넌트 제한)과 admin 모드 게이팅으로 주요 위험은 완화되었습니다. 외부 네트워크 호출 없음.

### Performance Considerations

삭제/열거 작업을 `spawn_blocking`으로 분리해 UI 블로킹을 회피합니다. 다만 대량 세션/대용량 폴더의 size 계산은 비용이 커질 수 있어 운영 환경 모니터링 권장.

### Files Modified During Review

없음.

### Gate Status

Gate: CONCERNS — docs/qa/gates/3.4-admin-guided-cleanup-safe-old-session-deletion.yml  
Risk profile: 미작성 (예상 경로: docs/qa/assessments/3.4-risk-20260124.md)  
NFR assessment: 미작성 (예상 경로: docs/qa/assessments/3.4-nfr-20260124.md)

### Recommended Status

Changes Required - 위 체크리스트 미완료 항목 반영 필요.

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

사용자 제공 검증 결과에 따라 수동 MVP 게이트 3종 시나리오(정상 삭제/활성 세션 보호/경로 탈출 방지)가 모두 수행되었고, 기존 구현 및 자동 테스트와 결합하여 AC 충족 증적이 확보되었습니다.

### Refactoring Performed

없음.

### Compliance Check

- Coding Standards: PASS
- Project Structure: PASS
- Testing Strategy: PASS (수동 MVP 게이트 시나리오 수행 완료)
- All ACs Met: PASS

### Improvements Checklist

- [x] MVP 수동 게이트 시나리오 수행 및 결과 기록 (삭제 성공/실패, 활성 세션 차단, traversal 입력 차단)
- [ ] Admin cleanup UI 선택/진단 표시에 대한 최소 UI 테스트 추가

### Security Review

수동 검증에서 경로 탈출/루트 외 삭제 시도가 차단됨을 확인했습니다.

### Performance Considerations

추가 이슈 없음.

### Files Modified During Review

없음.

### Gate Status

Gate: PASS → docs/qa/gates/3.4-admin-guided-cleanup-safe-old-session-deletion.yml  
Risk profile: 미작성 (예상 경로: docs/qa/assessments/3.4-risk-20260124.md)  
NFR assessment: 미작성 (예상 경로: docs/qa/assessments/3.4-nfr-20260124.md)

### Recommended Status

Ready for Done.
