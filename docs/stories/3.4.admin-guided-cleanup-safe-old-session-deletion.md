# Story 3.4: Admin Guided Cleanup: Safe Old Session Deletion

## Status

Approved

## Story

**As a** booth admin,  
**I want** to safely delete old session folders from the session root with strict confirmation,  
**so that** I can recover disk space without risking the active session or deleting outside Boothy's storage boundary.

[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]

## Acceptance Criteria

1. Given admin mode is unlocked, the admin can select one or more old sessions under the session root for deletion, and the currently active session is not deletable.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
2. Given a delete action is initiated, the UI requires explicit destructive confirmation (e.g., type-to-confirm) before deletion starts.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
3. Given a delete request is received, the backend enforces strict path safety: deletions are constrained to the configured session root and must not allow traversal outside that root.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#integration-approach]
   [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
4. Given deletion completes (success or failure), admin mode shows actionable diagnostics; the app does not crash and customer mode remains kiosk-safe.
   [Source: docs/prd.md#modifiednew-screens-and-views]
   [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
5. No new network dependencies are introduced for cleanup; offline-first policy remains intact.
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
   [Source: docs/architecture/security-integration.md#compliance-requirements]

## Tasks / Subtasks

- [ ] Task 1: Confirm dependencies and UX surface location (AC: 1, 2, 4)
  - [ ] Implement this story as an extension of the Epic 3 admin diagnostics surface (Story 3.3); do not introduce customer-mode UI beyond kiosk-safe messaging.
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
    [Source: docs/frontend-architecture.md#ui-gating-rules]
  - [ ] Ensure admin unlock is the gate for all cleanup actions (no cleanup access in customer mode).
    [Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend--react-ui]
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]

- [ ] Task 2: Add backend API for session enumeration (admin cleanup list) (AC: 1)
  - [ ] Define a new `boothy_*` Tauri command to return a list of candidate session folders under `boothy.sessionsRoot` (folder name + path; optional: last modified + size).
    [Source: docs/architecture/source-tree.md#integration-guidelines]
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
  - [ ] Ensure enumeration is constrained to the session root and is robust to unreadable folders (report in admin diagnostics, don't crash).
    [Source: docs/architecture/security-integration.md#security-testing]
    [Source: docs/prd.md#modifiednew-screens-and-views]

- [ ] Task 3: Add backend API for safe deletion (admin-only) (AC: 1, 3, 4, 5)
  - [ ] Define a new `boothy_*` Tauri command to delete selected session folders by session folder name(s) (not arbitrary paths).
    [Source: docs/architecture/source-tree.md#integration-guidelines]
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
  - [ ] Enforce path safety rules in backend:
    - Canonicalize targets and require they are direct children of the session root.
    - Reject any path that escapes the session root (no traversal), and never follow user-provided absolute paths.
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
  - [ ] Protect the currently active session from deletion (backend check), even if it is included by mistake in the request.
    [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [ ] Ensure heavy filesystem operations do not block the UI event loop (use background execution patterns).
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
    [Source: docs/architecture/tech-stack.md#existing-technology-stack]

- [ ] Task 4: Build admin UI for selecting and confirming session deletion (AC: 1, 2, 4)
  - [ ] Add an admin-only "Cleanup" surface that lists candidate sessions and allows multi-select (or single-select) deletion.
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
    [Source: docs/frontend-architecture.md#core-views-mvp]
  - [ ] Ensure the active session is clearly identified and cannot be selected for deletion (e.g., excluded from the list or shown disabled with an "Active" label).
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [ ] Add a destructive confirmation modal that requires explicit user intent (type-to-confirm), and clearly warns that deletion is permanent.
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [ ] On success/failure, show admin diagnostics; ensure any customer-facing messaging remains kiosk-safe and non-technical.
    [Source: docs/prd.md#modifiednew-screens-and-views]
    [Source: docs/frontend-architecture.md#key-principles]

- [ ] Task 5: Validate end-to-end behavior and add focused tests (AC: 1, 2, 3, 4, 5)
  - [ ] Add Rust unit tests for path canonicalization / "must be under session root" enforcement and active-session protection logic.
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
    [Source: docs/architecture/security-integration.md#security-testing]
  - [ ] Add at least one UI test (where existing patterns exist) for confirmation gating (delete action cannot proceed without explicit confirmation).
    [Source: docs/architecture/testing-strategy.md#new-testing-requirements]
  - [ ] Manual MVP gate scenarios:
    - Delete an old session folder (non-active) and verify it is removed and the app remains stable.
    - Attempt to delete the active session and verify it is blocked.
    - Attempt a traversal-like input and verify backend rejects it.
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
    [Source: docs/architecture/security-integration.md#security-testing]

## Dev Notes

### Context / Scope

- This story is being prepared out-of-sequence by request. Epic 3's defined dependency order is 3.1 -> 3.2 -> 3.3 -> 3.4; implement 3.4 only after the required admin diagnostics surface exists.
  [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
- Cleanup must not break the session storage contract: Boothy's storage boundary is the session root under `%USERPROFILE%\\Pictures\\dabi_shoot\\<session>\\{Raw,Jpg}`.
  [Source: docs/architecture/component-architecture.md#component-interaction-diagram]
  [Source: docs/architecture/security-integration.md#enhancement-security-requirements]

### Data Models / Settings

- Session root is configured via `boothy.sessionsRoot` in AppData `settings.json` (MVP default `%USERPROFILE%\\Pictures\\dabi_shoot`).
  [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]

### API / Command Naming

- New UI->backend commands must follow the `boothy_*` naming convention; events (if needed) use `boothy-*`.
  [Source: docs/architecture/source-tree.md#integration-guidelines]
  [Source: docs/architecture/api-design-and-integration.md#new-api-endpoints]

### Security / Path Safety (Non-Negotiable)

- All delete actions must be constrained to the session root and reject traversal / escaping paths after canonicalization.
  [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
- Customer mode should not expose technical details; admin mode can show detailed diagnostics.
  [Source: docs/prd.md#modifiednew-screens-and-views]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### File Locations (Guidance)

- Product code lives under:
  - React UI: `apps/boothy/src/`
  - Tauri backend: `apps/boothy/src-tauri/src/`
  [Source: docs/architecture/source-tree.md#new-file-organization]
- Session-related backend code should align with the session module boundaries (`session/*`) rather than introducing new ad-hoc locations.
  [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]

### Testing

- MVP emphasizes scenario-based manual validation; add focused unit tests for high-risk safety logic (path safety + active-session protection).
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-22 | 0.1 | Initial draft for Epic 3.4 (admin cleanup safe deletion) | Scrum Master (Bob) |
| 2026-01-22 | 0.2 | Fix sources/typography; align Testing heading; clarify active-session deletion UX; set Status to Approved | Product Owner (Sarah) |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

- [ ] TBD

### File List

#### New Files Created

- [ ] TBD

#### Modified Files

- [ ] TBD

## QA Results

TBD
