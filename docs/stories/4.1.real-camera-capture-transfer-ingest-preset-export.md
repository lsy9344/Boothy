# Story 4.1: Real Camera Capture + Transfer-Complete + Auto Ingest + Preset Apply + Export (E2E)

## Status

In Progress

## Story

**As a** booth operator,  
**I want** to connect a real Canon camera to Boothy and trigger capture from within the app (customer-mode capture button), while also supporting an external shutter remote,  
**so that** each new photo is downloaded into the active session `Raw/`, automatically ingested, has the currently selected preset applied (non-retroactive), and can be exported reliably (offline, kiosk-safe).

[Source: docs/prd.md#epic-4-real-camera-hardware-integration--field-validation]
[Source: docs/stories/epic-4-real-camera-hardware-integration.md#goal]

## Context / Problem

Epic 1~3 implemented a **mock camera + IPC + transfer-complete event-based ingest/preset/export pipeline**. Epic 4 validates this pipeline against real Canon hardware in field conditions. The MVP must operate offline (kiosk-safe) and remain stable when the camera is unavailable.

- The UI is **Tauri + React** and camera control/download is a **headless sidecar (.NET)** (no WPF UI).
  [Source: docs/decisions/adr-001-camera-integration.md#decision]
- Canon integration uses a validated controller in `reference/camerafunction/`. Rust FFI is out-of-scope for MVP.
  [Source: docs/prd.md#requirements]

## Dependencies / Preconditions

- Story 1.2 (mock sidecar IPC + `event.camera.photoTransferred` + ingest + preset apply) is already in place.
  [Source: docs/stories/1.2.camera-sidecar-ipc-transfer-ingest-preset-apply.md]
- IPC contract includes `protocolVersion`, `requestId`, and `correlationId` in JSON messages (request/response/event).
  [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]

## Acceptance Criteria

1. **Sidecar mock/real mode + graceful degradation**
   - Sidecar supports `mock` (existing) and `real` (Canon) modes.
   - If real prerequisites (driver/SDK/DLL) are missing, the camera features are disabled without crashing. Existing session browsing/editing/export still works.
   - Customer mode shows safe messages only; admin mode can display diagnostics (error code/reason/`correlationId`).
   [Source: docs/decisions/adr-001-camera-integration.md#decision]
   [Source: docs/prd.md#requirements]

2. **Camera connection status UI (connected / disconnected / error)**
   - UI displays at least three statuses: connected, disconnected, error.
   - In disconnected/error, capture attempts show customer-safe guidance while the rest of the UI works as before.
   [Source: docs/prd.md#requirements]

3. **Capture trigger (customer-mode button + external shutter)**
   - Customer mode provides a capture button that triggers sidecar `camera.capture` via Tauri.
   - External shutter on the camera should produce the same transfer-complete + ingest flow without UI interaction.
   - External trigger detection can use Canon SDK event hooks; polling/refresh is acceptable if required.
   [Source: docs/prd.md#requirements]

4. **Download location + transfer-complete event emitted only after full transfer**
   - Captures are downloaded into the session `Raw/` folder.
   - Sidecar emits `event.camera.photoTransferred` only after the file is fully written (no partial/temp events).
   [Source: docs/architecture/api-design-and-integration.md#photo-transferred-event-notification]
   [Source: docs/architecture/component-architecture.md#camera-sidecar-service-cnet-headless]

5. **Boothy file stabilization + ingest + preset apply (non-retroactive)**
   - Boothy treats `photoTransferred` as a signal, then verifies file stability before ingest.
   - Only newly ingested photos receive the current preset; existing photos remain unchanged.
   [Source: docs/architecture/component-architecture.md#boothy-file-arrival-watcher-tauri-backend]
   [Source: docs/architecture/component-architecture.md#boothy-preset-assignment-service-tauri-backend]

6. **Offline / kiosk operation (no account / no external dependencies)**
   - Capture, transfer, ingest, preset, export flows must not require network or third-party services.
   [Source: docs/prd.md#offline--no-account-policy-mvp]

7. **Logging / diagnostics with correlationId end-to-end**
   - Capture → transfer → ingest → export are correlated by `correlationId` in logs.
   - Logs live at `%APPDATA%\Boothy\logs\boothy.log` and `%APPDATA%\Boothy\logs\camera-sidecar.log`.
   [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]
   [Source: docs/architecture/development-environment.md#diagnostics]

8. **Status messages (customer-safe vs admin diagnostics)**
   - UI shows minimal progress states: `idle`, `capturing`, `transferring`, `stabilizing`, `importing`, `ready`, `error`.
   - Customer copy examples:
     - capturing: "Capturing..."
     - transferring: "Transferring..."
     - stabilizing: "Verifying file..."
     - importing: "Updating library..."
     - error (connection/prereq): "Camera connection required. Please ask staff."
     - error (transfer failure): "Transfer failed. Please try again."
   - Admin mode can show error code, reason, and `correlationId`.
   [Source: docs/prd.md#requirements]
   [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]

## Definition of Ready (Field Validation Preconditions)

- [ ] Record camera model, USB cable, PC specs, Windows version, power settings (USB selective suspend).
- [ ] Verify offline/kiosk conditions and test environment for external access is blocked.
- [ ] Verify Canon EDSDK entitlement: `docs/compliance/canon-edsdk-entitlement.md`
- [ ] Confirm log paths and file creation: `%APPDATA%\Boothy\logs\`
  [Source: docs/architecture/development-environment.md#diagnostics]

## Field Validation (Minimum Must-Pass)

### Phase 0: Preflight

- [ ] UI shows 3 camera states (connected/disconnected/error).
- [ ] Customer mode shows only safe messages (no diagnostic leakage).
- [ ] Admin mode displays diagnostic info including `correlationId`.

### Phase 1: Normal E2E (UI Capture Button)

- [ ] Capture 3 times via UI; each file lands in `Raw/`, and transfer-complete emits **after full write**.
- [ ] Boothy auto-ingests and selects the newest photo in the library.
- [ ] Current preset applies **only** to newly ingested photos (non-retroactive).
- [ ] Export succeeds at least once (offline state).

### Phase 1b: Normal E2E (External Shutter)

- [ ] External shutter capture flows match Phase 1 behavior.

### Phase 2: Failure / Recovery (field-grade)

- [ ] Unplug camera during capture/transfer → customer-safe message, admin diagnostics; recover after reconnect.
- [ ] SDK/driver missing → app remains usable, capture disabled, customer-safe guidance.

## Evidence Capture (Required)

- Test case execution timestamps, inputs (button/remote), results, and screenshots or video.
- Logs: boothy/sidecar log paths and correlationId evidence.
- File evidence: `Raw/`/`Jpg/` lists + confirmation that transfer-complete only after full write.
- Output locations:
  - `docs/qa/assessments/4.1-field-validation-YYYYMMDD.md`
  - `docs/qa/gates/4.1-real-camera-capture-transfer-ingest-preset-export.yml`
- Replace `YYYYMMDD` with the actual date (e.g., `20260124`).

## Tasks / Subtasks

- [x] Task 0: Field validation preflight (AC: 6, 7)
  - [x] Record environment details and verify log paths.
    [Source: docs/architecture/development-environment.md#diagnostics]

- [x] Task 1: Sidecar (real) minimum feature set (AC: 1, 3, 4, 7)
  - [x] Support `mock|real` mode selection (CLI arg or env).
  - [x] Implement `camera.getStatus` with connection status/model/diagnostics.
    [Source: docs/architecture/api-design-and-integration.md#get-camera-status]
  - [x] Handle `camera.capture` request and emit start/complete/fail events.
    [Source: docs/architecture/api-design-and-integration.md#capture-shoot-epic-4-planned]
  - [x] Implement external shutter detection (SDK events or polling/refresh).
    [Source: docs/prd.md#requirements]
  - [x] Download capture to `Raw/` and emit `event.camera.photoTransferred` only after full write.
    [Source: docs/architecture/api-design-and-integration.md#photo-transferred-event-notification]

- [x] Task 2: Boothy backend (IPC client/command/event) (AC: 1, 2, 3, 4, 7, 8)
  - [x] Implement request/response mapping for `camera.getStatus`/`camera.capture`.
    [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]
  - [x] Add Tauri command `boothy_trigger_capture`.
    [Source: docs/architecture/api-design-and-integration.md#capture-shoot-epic-4-planned]
  - [x] Bridge sidecar events into UI with customer-safe vs admin diagnostics.
    [Source: docs/architecture/component-architecture.md#boothy-camera-ipc-client-tauri-backend]
    [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]

- [x] Task 3: Boothy UI (customer capture button + status/progress) (AC: 2, 3, 8)
  - [x] Add capture button in customer mode to call Tauri command.
  - [x] Display camera status + progress states (`idle`~`error`).
  - [x] Customer-safe messages vs admin diagnostics separation.

- [ ] Task 4: E2E field validation + evidence/gate output (AC: 1~8)
  - [ ] Execute Phase 0~2 and write `docs/qa/assessments/4.1-field-validation-20260201.md`.
  - [x] Write gate decision `docs/qa/gates/4.1-real-camera-capture-transfer-ingest-preset-export.yml`.

## Dev Notes

- UI: Tauri + React; camera control/download via headless .NET sidecar (no WPF UI).
  [Source: docs/decisions/adr-001-camera-integration.md#decision]
- IPC: Named Pipe + JSON; `protocolVersion`/`requestId`/`correlationId` for diagnostics.
  [Source: docs/architecture/api-design-and-integration.md#api-integration-strategy]
- IPC pipe name: `\\.\pipe\boothy_camera_sidecar`
  [Source: docs/architecture/component-architecture.md#camera-sidecar-service-cnet-headless]
- Sidecar RPC/events: `camera.setSessionDestination`, `camera.getStatus`, `camera.capture`, `event.camera.photoTransferred`, `event.camera.error`.
  [Source: docs/architecture/api-design-and-integration.md#tauri-backend-camera-sidecar-named-pipe-rpc]
- Code locations:
  - Boothy backend: `apps/boothy/src-tauri/src/camera/`, `apps/boothy/src-tauri/src/session/`, `apps/boothy/src-tauri/src/watcher/`
  - Boothy UI: `apps/boothy/src/`
  - Sidecar: `apps/camera-sidecar/Camera/`, `apps/camera-sidecar/IPC/`, `apps/camera-sidecar/Logging/`
  - IPC models: `apps/boothy/src-tauri/src/camera/ipc_models.rs`, `apps/camera-sidecar/IPC/IpcMessage.cs`
  [Source: docs/architecture/source-tree.md#new-file-organization]
  [Source: docs/architecture/source-tree.md#integration-guidelines]
- Session folder rules: `<session>\{Raw,Jpg}`; sidecar downloads into `Raw/`.
  [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
  [Source: docs/architecture/component-architecture.md#camera-sidecar-service-cnet-headless]
- Boothy uses `photoTransferred` then file stabilization before ingest.
  [Source: docs/architecture/component-architecture.md#boothy-file-arrival-watcher-tauri-backend]
- Logs: `%APPDATA%\Boothy\logs\boothy.log`, `%APPDATA%\Boothy\logs\camera-sidecar.log`.
  [Source: docs/architecture/development-environment.md#diagnostics]

## Integration Verification

IV1: Camera disconnected state does not break existing browse/edit/export.
IV2: Offline/kiosk conditions do not require external access.
IV3: UI capture triggers transfer-complete → ingest → newest selection → preset apply.
IV4: External shutter produces same flow as IV3.
IV5: Failure scenarios show customer-safe messages; admin diagnostics available; recovery works.

## Testing

- Automated (recommended):
  - Rust: IPC request/response + event bridging tests
  - Sidecar: real-mode event handling tests where feasible
  [Source: docs/architecture/testing-strategy.md#new-testing-requirements]
- Manual (required for MVP gate):
  - Field Validation Phase 0~2 + evidence/gate output
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]

## Change Log

| Date       | Version | Description                                                   | Author |
| ---------- | ------- | ------------------------------------------------------------- | ------ |
| 2026-01-29 | 0.8     | Real-mode capture + DirItemRequestTransfer download to Raw/ + photoTransferred emit | James (Dev) |
| 2026-02-01 | 0.9     | Field validation Phase 0 기록 + 4.1 gate(CONCERNS) 작성 + 리로드(mockIPC) 오탐지 방지 | James (Dev) |
| 2026-01-29 | 0.7     | Real-mode camera.getStatus now probes Canon via EDSDK (digiCamControl patterns) | James (Dev) |
| 2026-01-24 | 0.2     | Story cleanup (encoding fix, AC/Tasks clarification)         | Bob    |
| 2026-01-24 | 0.3     | validate-story-draft applied (Status check, YYYYMMDD rule)   | Sarah (PO) |
| 2026-01-24 | 0.4     | IPC response matching + capture UI + real mode skeleton      | James (Dev) |
| 2026-01-24 | 0.5     | Capture status flow + event integration                      | James (Dev) |
| 2026-01-24 | 0.6     | Blocked due to missing EDSDK/hardware for real capture       | James (Dev) |

## Dev Agent Record

### Agent Model Used

GPT-5.2

### Debug Log References

- dotnet build (apps/camera-sidecar)
- cargo test (apps/boothy/src-tauri)
- cargo test (apps/boothy/src-tauri), npm test (apps/boothy)
- npm test (apps/boothy)
- 2026-02-01: npm test (apps/boothy), cargo test (apps/boothy/src-tauri), dotnet build (apps/camera-sidecar)

### Completion Notes List

- Sidecar mock/real mode selection and real-mode prerequisite checks (graceful degradation).
- Real-mode `camera.getStatus` initializes Canon EDSDK and enumerates the first camera to populate `cameraDetected`/`cameraModel`.
- Real-mode `camera.capture` now triggers `EdsSendCommand(TakePicture)`; external shutter + remote capture both flow through `DirItemRequestTransfer` → download to `Raw/` → emit `event.camera.photoTransferred` after full write.
- IPC request/response matching, `boothy_trigger_capture`/`boothy_get_camera_status` added.
- Customer capture UI + status messages with admin diagnostics separation.
- Capture progress (`capturing`~`ready`) state updates and event integration.
- Canon EDSDK entitlement/physical camera needed to validate real capture/transfer and complete field validation (Task 4).
- F5/리로드 시 `tauriMock.ts`가 `mockIPC`를 오탐지로 켜서 상태 갱신이 끊겨 보이는 간헐 이슈를 방지하도록 Tauri 런타임 감지 로직을 보강.
- Field validation Phase 0 기록 및 4.1 게이트(CONCERNS) 초안 작성.

### File List

#### New Files Created

- apps/camera-sidecar/Camera/ICameraController.cs
- apps/camera-sidecar/Camera/RealCameraController.cs
- apps/camera-sidecar/Camera/Canon/EdsdkNative.cs
- apps/camera-sidecar/Camera/Canon/CanonEdsdkProbe.cs
- docs/qa/assessments/4.1-field-validation-20260201.md
- docs/qa/gates/4.1-real-camera-capture-transfer-ingest-preset-export.yml

#### Modified Files

- apps/camera-sidecar/Camera/MockCameraController.cs
- apps/camera-sidecar/Camera/RealCameraController.cs
- apps/camera-sidecar/Program.cs
- apps/boothy/src-tauri/src/camera/ipc_client.rs
- apps/boothy/src-tauri/src/main.rs
- apps/boothy/src/components/ui/AppProperties.tsx
- apps/boothy/src/components/panel/MainLibrary.tsx
- apps/boothy/src/components/panel/CameraControlsPanel.tsx
- apps/boothy/src/App.tsx
- apps/boothy/src/tauriMock.ts
- docs/problem_history/2026-01-30-camera-lamp-power-cycle-stuck.md

## QA Results

TBD
