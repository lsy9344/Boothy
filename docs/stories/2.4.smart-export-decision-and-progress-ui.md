# Story 2.4: Smart Export Decision & Progress UI

## Status

In Progress

## Story

**As a** booth user,  
**I want** to choose whether to re-export all photos or only export remaining ones,  
**so that** I have control over quality vs. speed tradeoffs.

[Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]

## Acceptance Criteria

1. When export triggered (manual or T-0), decision modal appears within 500ms.
2. Selecting "Î™®Îëê ??ñ¥?∞Í∏∞" exports all Raw files regardless of background completion status.
3. Selecting "?¥Ïñ¥???¥Î≥¥?¥Í∏∞" exports only photos where `background_export_completed: false`.
4. Progress bar shows real-time completion percentage (e.g., "23/50 photos").
5. Progress bar displays current file being processed.
6. Export completion time <10s for "Continue" mode with typical session (50 photos, 80% background-completed).
7. Export completion time <5min for "Overwrite All" mode with typical session.
8. End screen appears immediately after export completes.
9. T-0 forced export successfully triggers modal and completes before N:59 reset.

[Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]

## Tasks / Subtasks

- [x] Task 1: Define export-trigger wiring and decision contract (AC: 1, 9)
  - [x] Manual export trigger: in Boothy session mode, route the existing Export affordances through the export decision flow (do not start export immediately without a choice).
    - Primary wiring points:
      - `apps/boothy/src/App.tsx`: `onExportClick` (context menu ?úExport ?¶‚Ä?action) currently opens `ExportPanel` / `LibraryExportPanel` ??change to open `ExportDecisionModal` when `boothySessionLabel` is set (active Boothy session).
      - `apps/boothy/src/App.tsx`: `<BottomBar onExportClick={...}>` currently toggles `LibraryExportPanel` ??change to open `ExportDecisionModal` when `boothySessionLabel` is set.
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]
    [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]
  - [x] T-0 forced trigger: on `boothy-session-t-zero` (N:50), automatically open the decision modal (must still be shown even if other UI is locked).
    - Suggested wiring point: `apps/boothy/src/App.tsx` where other Tauri event listeners are registered (near existing `listen('boothy-*', ...)` listeners).
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]
    [Source: docs/stories/2.1.session-timeline-core-warning-system.md#tasks--subtasks]
    [Source: docs/stories/2.2.t-0-lockout-application-reset-admin-settings.md#tasks--subtasks]
  - [x] Implement the backend decision entrypoint as a Tauri command `boothy_handle_export_decision(choice)` with the two modes (OverwriteAll / ContinueFromBackground).
    [Source: docs/prd-session-timeline-smart-export.md#tauri-command-integration]
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]

- [x] Task 2: Implement `ExportDecisionModal` UI (AC: 1, 2, 3)
  - [x] Build `<ExportDecisionModal>` using the app?ôs modal pattern (backdrop overlay, centered actions; blocks until selection). Use existing modal components as reference for structure/styling (e.g., `apps/boothy/src/components/modals/ConfirmModal.tsx`).
    [Source: docs/prd-session-timeline-smart-export.md#modal-workflow-integration]
  - [x] UI copy + actions: provide the two buttons labeled "Î™®Îëê ??ñ¥?∞Í∏∞" and "?¥Ïñ¥???¥Î≥¥?¥Í∏∞"; on selection, invoke `boothy_handle_export_decision(choice)`.
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]

- [x] Task 3: Implement export mode behavior and pipeline reuse (AC: 2, 3)
  - [x] Overwrite All: iterate all RAW files in the active session and export them all, ignoring any background completion flags.
    [Source: docs/prd-session-timeline-smart-export.md#fr11-overwrite-all-export-mode]
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]
  - [x] Continue: export only photos where session metadata marks `background_export_completed: false` (treat missing/unknown as false for safety/back-compat).
    [Source: docs/prd-session-timeline-smart-export.md#fr12-continue-export-mode]
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]
    [Source: docs/architecture/data-models-and-schema-changes.md#boothysession-folder-backed-session]
  - [x] Reuse the same export pipeline entrypoint used by manual export and background export (byte-identical outputs given the same input state).
    [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]
    [Source: docs/stories/2.3.background-export-queue-and-file-monitoring.md#tasks--subtasks]

- [x] Task 4: Implement export progress reporting and `<ExportProgressBar>` (AC: 4, 5)
  - [x] Implement backend export status tracking and a frontend hook (`useExportProgress`) that can obtain: total count, completed count, and current file being processed via Tauri events (preferred pattern in this codebase).
    - Define/emit events (Boothy naming): `boothy-export-progress` `{ completed: number, total: number, current_path: string }`, `boothy-export-complete` `{}`, `boothy-export-error` `{ message: string }`.
    - Suggested wiring point: `apps/boothy/src/App.tsx` (pattern reference: existing `listen('export-error', ...)`, `listen('batch-export-progress', ...)` handlers).
    [Source: docs/prd-session-timeline-smart-export.md#code-organization-and-standards]
  - [x] Build `<ExportProgressBar>` UI showing `completed/total` and the current file; ensure it remains visible until export completes.
    - Render it at the top application level (e.g., from `apps/boothy/src/App.tsx`) so it remains visible across panel navigation and during lock overlays.
    [Source: docs/prd-session-timeline-smart-export.md#fr13-export-progress-visualization]
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]

- [x] Task 5: End screen integration after export completion (AC: 8, 9)
  - [x] After export finishes, show the end screen overlay (from Story 2.2) immediately; keep customer mode non-dismissible and allow admin bypass per Story 2.2.
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]
    [Source: docs/stories/2.2.t-0-lockout-application-reset-admin-settings.md#tasks--subtasks]
  - [x] Ensure the forced export path (T-0) + end screen completes before the N:59 reset boundary (and respects any reset grace-period rules from Story 2.2).
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/stories/2.2.t-0-lockout-application-reset-admin-settings.md#tasks--subtasks]

- [x] Task 6: Logging + failure behavior (AC: 6, 7)
  - [x] Log export decision selections and export mode, and log per-file start/complete/failure (with correlation IDs if available) for field diagnostics.
    [Source: docs/prd-session-timeline-smart-export.md#logging-requirements-nfr8-from-baseline-prd]
    [Source: docs/architecture/coding-standards.md#critical-integration-rules]
  - [x] Export failures must surface an appropriate error message and must not leave the app in a broken state.
    - UI guidance: on `boothy-export-error`, show the error message in the progress UI (red state) and provide a single ?úÌôï???´Í∏∞??action to dismiss the progress UI and return to the pre-export state (allowing retry by re-triggering export).
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]

- [ ] Task 7: Tests + validation scenarios (AC: 1-9)
  - [ ] Manual (MVP gate): verify modal appears within 500ms (manual + T-0); verify each mode exports correct set; verify outputs land in `{session_folder}/Jpg/`; verify end screen appears post-export; verify app remains responsive.
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
    [Source: docs/prd-session-timeline-smart-export.md#story-24-smart-export-decision--progress-ui]
  - [x] Unit (where feasible): add Rust unit tests for ?úcontinue-mode selection??logic (filtering by `background_export_completed`) and for status/progress state transitions.
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
  - [ ] Regression: confirm existing editing + preset + export results remain consistent (manual export byte-identical to pre-change for the same input/preset state).
    [Source: docs/architecture/testing-strategy.md#regression-testing]

## Dev Notes

### Previous Story Insights

- This story depends on background completion tracking from Story 2.3 (`background_export_completed`) and must treat missing flags as ?únot completed??to preserve backward compatibility.
  [Source: docs/stories/2.3.background-export-queue-and-file-monitoring.md#acceptance-criteria]
  [Source: docs/architecture/data-models-and-schema-changes.md#boothysession-folder-backed-session]
- T-0 and N:59 timeline boundary events originate from Story 2.1; lockout/reset/end-screen behavior originates from Story 2.2. This story wires export decision + progress into those boundaries.
  [Source: docs/stories/2.1.session-timeline-core-warning-system.md#tasks--subtasks]
  [Source: docs/stories/2.2.t-0-lockout-application-reset-admin-settings.md#tasks--subtasks]

### Data Models

- Session metadata may be stored at the session root (e.g., `boothy.session.json`) and is intended to be append-only/backward-compatible; use it to determine which photos are background-export completed for Continue mode.
  [Source: docs/architecture/data-models-and-schema-changes.md#boothysession-folder-backed-session]
  [Source: docs/prd-session-timeline-smart-export.md#background-export-processing-integration]

### API Specifications

- Export decision is communicated from UI to backend via a Tauri command (`boothy_handle_export_decision(choice)`); export progress/state is exposed via Boothy Tauri events (`boothy-export-progress`, `boothy-export-complete`, `boothy-export-error`).
  [Source: docs/prd-session-timeline-smart-export.md#tauri-command-integration]
  [Source: docs/prd-session-timeline-smart-export.md#code-organization-and-standards]
- Keep Tauri event naming consistent with project conventions (`boothy-*` for events) if new events are introduced.
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### Component Specifications

- Implement the decision modal and progress UI using the shared modal/overlay approach so it blocks interaction but does not block backend work (background exports and export pipeline execution).
  [Source: docs/prd-session-timeline-smart-export.md#modal-workflow-integration]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### File Locations (Guidance)

- Product code: `apps/boothy/src/` (React UI) and `apps/boothy/src-tauri/src/` (Rust backend).
  [Source: docs/architecture/source-tree.md#new-file-organization]
- Suggested module placement (from PRD): `src/components/session/ExportDecisionModal.tsx`, `src/components/session/ExportProgressBar.tsx`, and backend session modules under `src-tauri/src/session/`.
  [Source: docs/prd-session-timeline-smart-export.md#code-organization-and-standards]

### Testing

- Follow the MVP gate emphasis on scenario-based manual testing, plus focused unit tests for pure selection/progress logic.
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

### Technical Constraints

- Keep export work off the UI thread and avoid introducing new dependencies.
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  [Source: docs/architecture/tech-stack.md#existing-technology-stack]

### Project Structure Notes

- `docs/architecture/unified-project-structure.md` is not present in this repo; use `docs/architecture/source-tree.md` for file placement guidance.
  [Source: docs/architecture/source-tree.md#new-file-organization]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-16 | 0.1 | Initial draft created from Epic 2 PRD + architecture | Scrum Master (Bob) |
| 2026-01-16 | 0.2 | Align Tauri command naming with Boothy standards; normalize Dev Notes testing subheading | Product Owner (Sarah) |
| 2026-01-16 | 0.3 | Specify concrete wiring points for triggers/progress/error; set story to Approved | Product Owner (Sarah) |
| 2026-01-16 | 0.4 | Implement export decision flow, Boothy export backend, and progress UI wiring | Dev (James) |
| 2026-01-16 | 0.5 | Fix Boothy export progress to count completed files before emitting UI updates | Dev (James) |

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `cargo test` (apps/boothy/src-tauri) passed; warnings about unused imports/vars in legacy modules and `reference/` rawler crate.

### Completion Notes List

- [x] `cargo test` (apps/boothy/src-tauri) completed with warnings only.
- [ ] Manual MVP export validation pending (modal timing, export modes, end screen, responsiveness).

### File List

#### New Files Created

- [ ] apps/boothy/src-tauri/src/session/export.rs
- [ ] apps/boothy/src/hooks/useExportProgress.tsx
- [ ] apps/boothy/src/components/session/ExportDecisionModal.tsx
- [ ] apps/boothy/src/components/session/ExportProgressBar.tsx

#### Modified Files

- [x] apps/boothy/src-tauri/src/main.rs
- [ ] apps/boothy/src-tauri/src/session/mod.rs
- [ ] apps/boothy/src/components/ui/AppProperties.tsx
- [ ] apps/boothy/src/App.tsx

## QA Results

TBD
