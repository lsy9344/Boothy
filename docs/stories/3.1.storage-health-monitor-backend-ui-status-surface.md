# Story 3.1: Storage Health Monitor (Backend) + UI Status Surface

## Status

Approved

## Story

**As a** booth operator/admin,  
**I want** Boothy to proactively monitor available disk space for the active session drive and surface a kiosk-safe warning,  
**so that** we prevent booth downtime and reduce risk of data loss due to low disk space.

[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#goal]
[Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#enhancement-details]
[Source: docs/prd.md#modifiednew-screens-and-views]

## Acceptance Criteria

1. Given a session is active, the backend periodically samples free disk space for the drive that contains the active session root and emits a UI-facing status event at a fixed interval (default: 10s) without blocking the UI thread.  
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
   [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
2. Given sampled free space drops below the configured **warning threshold**, customer mode shows a **non-blocking** kiosk-safe warning surface (banner/toast) that does not expose technical details.  
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
   [Source: docs/frontend-architecture.md#ui-gating-rules]
3. Given sampled free space returns above the warning threshold, the warning surface is automatically cleared without restarting the app.  
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
4. The emitted status payload is stable and forward-compatible for Story 3.2/3.3 (includes status classification and enough context to implement critical lockout + admin diagnostics later).  
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
5. If free-space sampling fails due to transient IO/path errors, the system reports an `unknown` status (warn/admin-visible only) rather than hard-blocking the booth workflow in this story.  
   [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#risk-mitigation]

## Tasks / Subtasks

- [ ] Task 1: Add storage health settings (AC: 1, 2, 3)
  - [ ] Extend AppData settings (`settings.json`) with Boothy storage health configuration (append-only/backward compatible) including:
    - Enabled flag (boolean; default enabled) to allow admin-only rollback/disable if needed
    - Warning threshold (bytes)
    - Critical threshold (bytes; used by Story 3.2 but defined now for consistent payload classification)
    - Poll interval seconds (default 10)
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#risk-mitigation]
  - [ ] Set sensible defaults and ensure missing fields do not break existing installs (treat missing as defaults).
    [Source: docs/architecture/data-models-and-schema-changes.md#schema-integration-strategy]

- [ ] Task 2: Implement free-space sampling utility (AC: 1, 5)
  - [ ] Implement a backend function that returns free bytes/total bytes for the volume containing a given canonical session path (Windows).
    - If exact implementation approach is not documented, prefer the smallest/lowest-risk dependency (or a direct Windows API call), and isolate it behind a small interface for testing.
    [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
  - [ ] On IO errors, return a typed `unknown` status with a diagnostic (admin-visible) rather than bubbling a hard error to customer mode in this story.
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#risk-mitigation]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

- [ ] Task 3: Add backend storage health monitor + event emission (AC: 1, 4, 5)
  - [ ] Add a new backend monitor/service that:
    - Starts when a session becomes active (or on app startup if a session is restored)
    - Samples on an interval (default 10s; configurable via settings)
    - Computes a status classification: `healthy | warning | critical | unknown`
    - Emits a Tauri event `boothy-storage-health` with a payload containing status + bytes (and optional diagnostic for admin mode)
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
    [Source: docs/architecture/source-tree.md#integration-guidelines]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  - [ ] Define a minimal, forward-compatible event payload contract that (at minimum) includes:
    - `status`
    - `freeBytes`, `totalBytes`
    - `warningThresholdBytes`, `criticalThresholdBytes`
    - `sampledAt` (timestamp)
    - optional admin-only diagnostic details (no customer-mode technical leakage)
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
  - [ ] Ensure the monitor does not block UI responsiveness (use async/background patterns; avoid long blocking calls on the main thread).
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  - [ ] Likely touchpoints (verify in codebase):
    - `apps/boothy/src-tauri/src/main.rs` (service init / app setup)
    - `apps/boothy/src-tauri/src/session/manager.rs` (active session lifecycle + `boothy-session-changed`)
    - `apps/boothy/src-tauri/src/file_management.rs` (settings load/save)
    [Source: docs/architecture/source-tree.md#new-file-organization]

- [ ] Task 4: Add UI warning surface driven by `boothy-storage-health` (AC: 2, 3, 4)
  - [ ] Add a frontend listener for `boothy-storage-health` (pattern: existing `listen('boothy-*', ...)` handlers) and store the latest status in app state.
    [Source: docs/frontend-architecture.md#eventcommand-contract-ui-facing]
    [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]
  - [ ] Customer mode UX:
    - When status is `warning`, show a non-blocking banner/toast with customer-safe copy (no bytes/drive letters)
    - When status returns to `healthy`, auto-hide the warning
    [Source: docs/frontend-architecture.md#ui-gating-rules]
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#acceptance-criteria]
  - [ ] Admin mode UX (minimal for this story):
    - Either show the same banner or include minimal additional diagnostic (e.g., free space numbers) if it can be done without creating a full admin panel (Story 3.3).
    [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]
  - [ ] Likely touchpoints (verify in codebase):
    - `apps/boothy/src/App.tsx`
    - `apps/boothy/src/tauriMock.ts` (optional: mock event for UI dev/testing)
    [Source: docs/architecture/source-tree.md#new-file-organization]

- [ ] Task 5: Tests + validation scenarios (AC: 1-5)
  - [ ] Manual (MVP gate): simulate low space by temporarily setting warning threshold above current free bytes and confirm:
    - Warning surface appears in customer mode
    - Warning clears when threshold is lowered (or when free space increases) without restart
    - App remains responsive while monitor runs
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  - [ ] Unit (where feasible): add Rust unit tests for status classification logic (healthy/warning/critical/unknown) independent of OS sampling.
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

## Dev Notes

### Previous Story Insights

- The latest Epic 2 story `docs/stories/2.4.smart-export-decision-and-progress-ui.md` is `Ready for Review`. This Epic 3 story is being prepared by request ahead of Epic 2 bookkeeping completion.  
  [Source: docs/stories/2.4.smart-export-decision-and-progress-ui.md#status]
- Active session folders are rooted at `%USERPROFILE%\\Pictures\\dabi_shoot\\<session>\\{Raw,Jpg}` and the app constrains the library to `Raw/`; storage health should key off the active session's canonical root/paths.  
  [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
  [Source: docs/architecture/component-architecture.md#component-interaction-diagram]

### Data Models / Settings

- Boothy extends RapidRAW AppData settings (`settings.json`) with Boothy-specific fields; new configuration must be append-only and backward compatible.  
  [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### Events / Contracts

- Naming convention: Tauri commands use `boothy_*` and Tauri events use `boothy-*`. This story introduces `boothy-storage-health` as an emitted event.  
  [Source: docs/architecture/source-tree.md#integration-guidelines]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
- Frontend integrates via Tauri event listeners (`listen(...)`) and command invocations (`invoke(...)`); follow existing app-level listener patterns.  
  [Source: docs/frontend-architecture.md#eventcommand-contract-ui-facing]
  [Source: docs/architecture/component-architecture.md#boothy-ui-extensions-react]

### File Locations (Guidance)

- Product code locations:
  - React UI: `apps/boothy/src/`
  - Tauri backend: `apps/boothy/src-tauri/src/`  
  [Source: docs/architecture/source-tree.md#new-file-organization]

### Testing

- MVP quality gate favors scenario-based manual validation; add unit tests where they help stabilize core logic (status classification).  
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

### Technical Constraints

- Offline-first: no new network dependency in the booth-critical workflow.  
  [Source: docs/prd.md#non-functional]
  [Source: docs/prd.md#offline--no-account-policy-mvp]
- Platform assumption: Boothy runs on Windows (Tauri) and free-space sampling should use Windows volume/drive APIs.  
  [Source: docs/architecture/tech-stack.md#existing-technology-stack]
- Error/recovery scenarios should be customer-friendly with admin diagnostics; this story implements warning surface + `unknown` status handling, while critical lockout + full admin diagnostics are handled in Story 3.2/3.3.  
  [Source: docs/prd.md#modifiednew-screens-and-views]
  [Source: docs/stories/epic-3-storage-health-disk-space-guardrails.md#story-sequence-dependency-ordered]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-22 | 0.1 | Initial draft created from Epic 3 + architecture context | Scrum Master (Bob) |
| 2026-01-22 | 0.2 | Normalize encoding artifacts in draft | Scrum Master (Bob) |
| 2026-01-22 | 0.3 | Format status literals consistently | Scrum Master (Bob) |
| 2026-01-22 | 0.4 | PO validation fixes (status, payload contract, rollback flag, testing heading) | Product Owner (Sarah) |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

- [ ] TBD

### File List

#### New Files Created

- [ ] TBD

#### Modified Files

- [ ] TBD

## QA Results

TBD

