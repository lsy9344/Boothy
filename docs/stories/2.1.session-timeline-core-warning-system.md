# Story 2.1: Session Timeline Core & Warning System

## Status

In Progress

## Story

**As a** kiosk operator,  
**I want** the Boothy app to enforce strict 50-minute session windows with advance warning,  
**so that** sessions complete predictably and users have time to finish their work before forced closure.  
[Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]

## Acceptance Criteria

1. Session started at N:00 displays countdown from 50:00 and reaches 00:00 at exactly N:50.  
   [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
2. Session started at N:42 displays countdown from 08:00 and reaches 00:00 at N:50 (not N:42+50).  
   [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
3. Countdown updates at least every second and maintains accuracy within +/- 2 seconds of system time over full session.  
   [Source: docs/prd-session-timeline-smart-export.md#non-functional-requirements]
4. At T-5 (05:00), modal appears within 500ms with warning message.  
   [Source: docs/prd-session-timeline-smart-export.md#non-functional-requirements]
5. Customer mode: modal blocks editing actions until user clicks "확인".  
   [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
6. Admin mode: modal displays but can be dismissed immediately without blocking.  
   [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
7. Countdown timer is visible in both Editor and Library screens.  
   [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]

## Tasks / Subtasks

- [x] Task 1: Define timeline semantics + event contract (AC: 1, 2, 3, 4)
  - [x] Specify the "fixed window" end boundary calculation using wall-clock time (end boundary is `HH:50:00` for the current hour; late entry before `HH:50` anchors to the same hour's `HH:50` (e.g., `HH:42 -> 08:00` remaining), and late entry at/after `HH:50` results in `0` remaining with immediate `boothy-session-t-zero` emission).  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
  - [x] Define the backend-to-frontend event payload(s) for remaining time ticks and the T-5 trigger.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]
  - [x] Emit the timeline events using Boothy event naming conventions (hyphenated `boothy-*`), mapping the PRD's `session:*` examples to the following concrete names:
    - [x] `boothy-session-timer-tick` (every second): `{ remaining_seconds: number }`
    - [x] `boothy-session-t-minus-5` (at 05:00 remaining): `{ message: string }`
    - [x] `boothy-session-t-zero` (at 00:00 remaining): `{}` (event emission only in this story; UI lockout is Story 2.2)
    - [x] `boothy-session-reset` (at N:59): `{}` (event emission only in this story; reset behavior is Story 2.2)
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]

- [x] Task 2: Implement `SessionTimer` backend service (Rust + tokio) and emit events (AC: 1, 2, 3, 4)
  - [x] Run as a tokio background task; compute remaining seconds from wall-clock time (not elapsed counters) and align tick emission to wall-clock second boundaries to minimize drift.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]
    [Source: docs/prd-session-timeline-smart-export.md#risk-assessment-and-mitigation]
    [Source: docs/architecture/tech-stack.md#existing-technology-stack]
  - [x] Emit `boothy-session-timer-tick` events with `{ remaining_seconds }` for UI countdown.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]
  - [x] Emit the T-5 event at exactly 05:00 remaining (do not rely on the 1-second tick alone; schedule/trigger precisely enough to meet the 500ms modal requirement) and include the warning message text in the event payload.  
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
    [Source: docs/prd-session-timeline-smart-export.md#non-functional-requirements]
  - [x] Emit the T-0 and N:59 reset boundary events (event emission only; UI lockout/reset behavior is Story 2.2).  
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]
  - [x] Detect large wall-clock jumps (forward/backward) and log warnings for diagnostics.  
    [Source: docs/prd-session-timeline-smart-export.md#risk-assessment-and-mitigation]
  - [x] Ensure "single timer source of truth": exactly one active timer per active session; stop/replace timer on session change.  
    [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]

- [x] Task 3: Add `SessionCountdown` UI + event subscription (React/TS) (AC: 1, 2, 3, 7)
  - [x] Implement a React component that displays remaining time in `MM:SS`, updating on each `boothy-session-timer-tick` event.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]
  - [x] Display the countdown in both Main Editor and Library screen headers (or equivalent top UI sections), without breaking existing navigation/screen access.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/prd-session-timeline-smart-export.md#navigation-flow-enhancements]
  - [x] Ensure event listeners are registered/unregistered safely (avoid duplicate listeners; follow the existing single `listen(...)` registration/cleanup pattern).  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]

- [x] Task 4: Implement T-5 warning modal UX and customer/admin branching (AC: 4, 5, 6)
  - [x] Implement a modal/overlay consistent with the app modal pattern (portal/overlay approach) so it blocks UI actions but not backend background tasks.  
    [Source: docs/stories/epic-2-session-timeline-smart-export.md#key-architectural-decisions]
    [Source: docs/prd-session-timeline-smart-export.md#modal-workflow-integration]
  - [x] Customer mode behavior: modal blocks editing actions until user clicks "확인" (do not stop background backend tasks).  
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
  - [x] Admin mode behavior: modal appears but is non-blocking/dismissible immediately.  
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
  - [x] Wire modal visibility to `boothy-session-t-minus-5` and ensure it appears within 500ms of trigger (UI responsiveness goal).  
    [Source: docs/prd-session-timeline-smart-export.md#non-functional-requirements]
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]

- [x] Task 5: Warning message text sourcing (AC: 4)
  - [x] Load the T-5 warning message from configuration, with a default fallback of `"세션 종료가 5분 남았습니다"` until Story 2.2 introduces UI-based editing.  
    [Source: docs/stories/epic-2-session-timeline-smart-export.md#human-only-decisions-inputs-resolved]
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
  - [x] Persist configuration under the existing Boothy settings namespace (append-only, backward compatible).  
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  - [x] Use the existing Boothy settings pattern in `settings.json` (Boothy-specific keys are already stored in `AppSettings` with a `boothy_` prefix); add a new optional key for the T-5 message (e.g., `boothy_t_minus_5_warning_message`).  

- [ ] Task 6: Tests + validation scenarios (AC: 1, 2, 3, 4, 5, 6, 7)
  - [x] Add Rust unit tests for the time-boundary calculation and late-entry behavior (e.g., N:00 -> 50:00 remaining; N:42 -> 08:00 remaining), and for T-5 triggering.  
    [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
  - [ ] Validate UI behavior manually (MVP gate): countdown visible on Editor + Library; T-5 modal blocks in customer mode but not in admin mode; timer continues to tick.  
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  - [ ] Regression: confirm session creation + photo ingest/preset apply + export flows still function (no new network dependency; timer UI must not interfere).  
    [Source: docs/architecture/testing-strategy.md#regression-testing]
    [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]

## Dev Notes

### Dependencies / Sequencing

- This is the foundation story for Epic 2; no Epic 2 dependencies.  
  [Source: docs/prd-session-timeline-smart-export.md#story-21-session-timeline-core-warning-system]
- Assumes an active session concept exists and remains the integration boundary; this story must not change the session folder structure.  
  [Source: docs/stories/epic-2-session-timeline-smart-export.md#compatibility-requirements]
  [Source: docs/architecture/data-models-and-schema-changes.md#boothysession-folder-backed-session]
- Note: latest Story 1.3 is not marked `Done` (currently `Ready for Review`), but it introduced mode/logging infrastructure that may be reused.  
  [Source: docs/stories/1.3.production-hardening-admin-surface-packaging-diagnostics.md#status]
  [Source: docs/stories/1.3.production-hardening-admin-surface-packaging-diagnostics.md#dev-agent-record]

### Key Components & Contracts

- Backend timer runs in Rust (tokio) and emits events; frontend listens and renders countdown + modal.  
  [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]
  [Source: docs/architecture/tech-stack.md#existing-technology-stack]
- Existing session lifecycle integration point: session activation already emits `boothy-session-changed`; the timer should treat session change as the boundary for resetting its internal timeline state (without spawning multiple timers).  
  [Source: docs/architecture/component-architecture.md#boothy-session-manager-tauri-backend]
- Mode gating must continue to follow the existing "hide not disable" and backend-as-source-of-truth approach; use admin/customer mode state to decide whether the T-5 modal blocks.  
  [Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend-react-ui]
  [Source: docs/architecture/security-integration.md#enhancement-security-requirements]

### Naming + Project Structure Notes

- PRD examples use `session:*` event names, while Boothy coding standards specify `boothy-*` naming. This story uses `boothy-session-*` to remain consistent with Boothy conventions.  
  [Source: docs/prd-session-timeline-smart-export.md#session-timeline-system-integration]
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
- Suggested file locations from PRD (adjust to actual repo structure as needed): `apps/boothy/src-tauri/src/session/timer.rs` and UI components under `apps/boothy/src/components/session/*`.  
  [Source: docs/prd-session-timeline-smart-export.md#code-organization-and-standards]
  [Source: docs/architecture/source-tree.md#new-file-organization]

### Testing

- Follow the testing strategy: prefer scenario-based validation as an MVP gate, plus unit tests for pure timeline logic.  
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-16 | 0.1 | Initial draft created from Epic 2 + PRD + architecture | Scrum Master (Bob) |
| 2026-01-16 | 0.2 | Implement session timer events, countdown UI, and T-5 warning modal | James (dev) |

## Dev Agent Record

### Agent Model Used

Codex (GPT-5)

### Debug Log References

- `cargo test session::timer` (initial run timed out after ~60s but session timer tests passed; rerun failed with incremental cache access denied; warnings in upstream crates)
- `cargo test session::timer` (CARGO_INCREMENTAL=0) passed; warnings in upstream crates
- `cargo test session::timer` (CARGO_INCREMENTAL=0) passed; warnings in upstream crates (post T-5 emission guard)

### Completion Notes List

- [x] Added wall-clock SessionTimer service with tick + T-5/T-0/reset event emission and time-jump logging.
- [x] Wired countdown UI into Editor and Library headers with shared event listener.
- [x] Added T-5 warning modal with customer blocking and admin non-blocking behavior.
- [x] Added T-5 emission guard to ensure warning triggers even if timed event is missed.
- [ ] Manual UI validation and regression tests pending (Task 6) after T-5 fix; `cargo test session::timer` passed with CARGO_INCREMENTAL=0; warnings in upstream crates.

### File List

#### New Files Created

- [x] apps/boothy/src-tauri/src/session/timer.rs
- [x] apps/boothy/src/components/session/SessionCountdown.tsx
- [x] apps/boothy/src/components/modals/SessionWarningModal.tsx

#### Modified Files

- [x] apps/boothy/src-tauri/src/session/mod.rs
- [x] apps/boothy/src-tauri/src/main.rs
- [x] apps/boothy/src-tauri/src/ingest/file_watcher.rs
- [x] apps/boothy/src/App.tsx
- [x] apps/boothy/src/components/panel/editor/EditorToolbar.tsx
- [x] apps/boothy/src/components/panel/Editor.tsx
- [x] apps/boothy/src/components/panel/MainLibrary.tsx
- [x] docs/stories/2.1.session-timeline-core-warning-system.md

## QA Results

TBD
