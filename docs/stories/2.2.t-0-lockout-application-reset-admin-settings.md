# Story 2.2: T-0 Lockout, Application Reset & Admin Settings

## Status

In Progress

## Story

**As a** kiosk operator,  
**I want** the app to automatically lock editing and reset at session boundaries,  
**so that** the kiosk is ready for the next user and sessions never overlap.

**As an** administrator,  
**I want** to bypass timeline restrictions and configure messages via UI,  
**so that** I can troubleshoot issues and customize the kiosk experience without editing config files.

[Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]

## Acceptance Criteria

1. Customer mode - T-0 lockout:
   - At T-0 (00:00), all editing buttons become disabled and UI shows "session locked" state.
   - Capture, preset changes, delete, and rotate actions do not execute in locked state.
   - No bypass option available.
2. Admin mode - T-0 lockout:
   - At T-0, lockout notification displays with "Dismiss" or "Continue Working" button.
   - Admin can bypass lockout and continue editing past N:50.
   - Bypass action logged with timestamp.
3. Customer mode - N:59 reset:
   - At N:59, application clears session context and returns to session entry screen.
   - If an export/file write operation is in progress at N:59, delay reset until it completes (up to a bounded grace period), then proceed with reset.
   - No bypass option available.
4. Admin mode - N:59 reset:
   - At N:59, reset notification displays with "Postpone" or "Reset Now" options.
   - Admin can postpone reset to continue troubleshooting.
   - If an export/file write operation is in progress at N:59, delay reset until it completes (up to a bounded grace period), then proceed unless admin chooses to postpone.
   - Postpone action logged with timestamp.
5. End screen:
   - End screen displays configurable message ("이용해주셔서 감사합니다." by default).
   - End screen is full-screen and non-dismissible in customer mode.
   - Admin mode can bypass end screen.
6. Admin Settings UI:
   - Settings panel accessible only in admin mode.
   - Can edit end screen message and T-5 warning message.
   - Changes saved to AppData settings (`settings.json`) and take effect immediately (no restart).
   - Restore defaults button resets to original Korean messages.
   - Input validation prevents empty messages.
7. Admin override indicator:
   - Visual indicator (e.g., badge, banner) shows when admin has bypassed timeline restrictions.
   - Indicator visible throughout session in admin mode.

[Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]

## Tasks / Subtasks

- [x] Task 1: Define lockout/reset wiring contract (AC: 1, 2, 3, 4)
  - [x] Use the Epic 2 timeline event contract from Story 2.1 for T-0 and N:59 boundaries:
    - [x] T-0 event: `boothy-session-t-zero`
    - [x] N:59 reset event: `boothy-session-reset`
    [Source: docs/stories/2.1.session-timeline-core-warning-system.md#tasks--subtasks]
  - [x] Ensure customer/admin mode detection uses the existing mode/auth single source of truth.  
    [Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend-react-ui]

- [x] Task 2: Implement T-0 lockout UI state (customer + admin) (AC: 1, 2)
  - [x] On `boothy-session-t-zero`, enter "locked" UI state for customer mode (read-only): disable capture/preset/delete/rotate and show a clear lock overlay.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
  - [x] In admin mode, show the lockout notification with the two actions ("Dismiss" / "Continue Working") without forcing lockout if admin chooses to continue.  
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
  - [x] Enforce lockout defensively (not UI-only): ensure locked-state prevents executing the booth-critical write actions even if invoked programmatically.  
    [Source: docs/architecture/security-integration.md#enhancement-security-requirements]

- [x] Task 3: Implement N:59 reset flow (customer + admin) (AC: 3, 4)
  - [x] Customer mode: on `boothy-session-reset`, clear session context and route to the session entry screen (no bypass).  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
  - [x] Admin mode: on `boothy-session-reset`, show "Postpone" / "Reset Now". Postpone keeps the app in the current state; Reset Now performs the same reset as customer mode.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
  - [x] Add protection against reset during active export/file operations:
    - [x] Delay reset until export completes, up to a bounded grace period of **30 seconds** (must not extend past the top of the hour).  
    - [x] If the grace period is exceeded, proceed with reset but ensure a "no partial outputs" outcome (cancel/abort export + best-effort cleanup) and log a warning.  
    [Source: docs/prd-session-timeline-smart-export.md#risk-assessment-and-mitigation]

- [x] Task 4: Add End Screen modal component and display integration point (AC: 5)
  - [x] Implement `<EndScreenModal>` as a full-screen overlay that blocks customer interaction and can be bypassed in admin mode.  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
  - [x] Admin bypass UX (clarification): show an explicit admin-only UI affordance (e.g., "Exit End Screen" button) to dismiss the end screen; do not rely on keyboard shortcuts. Customer mode remains non-dismissible.  
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
  - [x] Provide a clear integration point for Story 2.4 to show the end screen after export completes (no export decision UI in this story).  
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]

- [x] Task 5: Admin Settings UI for timeline messages (AC: 6)
  - [x] Implement an admin-only settings panel to edit:
    - [x] End screen message (default: "이용해주셔서 감사합니다.")
    - [x] T-5 warning message (default: "세션 종료가 5분 남았습니다")
    [Source: docs/prd-session-timeline-smart-export.md#admin-configuration-ui]
  - [x] Persist settings to Boothy configuration (append-only, backward compatible) under the existing `settings.json` / `boothy.*` namespace (do not introduce schema-breaking config).  
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  - [x] Settings keys (clarification; align with existing `boothy_` prefix pattern):
    - [x] `boothy_end_screen_message` (string, default: `"이용해주셔서 감사합니다."`)
    - [x] `boothy_t_minus_5_warning_message` (string, default: `"세션 종료가 5분 남았습니다"`)
    - [x] (Optional) `boothy_reset_grace_period_seconds` (number, default: `30`)  
    [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
    [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]
  - [x] Ensure runtime wiring: updating settings immediately affects the T-5 modal text and the end screen message (no restart).  
    [Source: docs/prd-session-timeline-smart-export.md#admin-configuration-ui]
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
  - [x] Ensure changes take effect immediately (no restart); add Save/Cancel, non-empty validation, and Restore Defaults.  
    [Source: docs/prd-session-timeline-smart-export.md#admin-configuration-ui]

- [x] Task 6: Admin override logging + indicator (AC: 2, 4, 7)
  - [x] Log all admin override actions with timestamp and action type:
    - [x] T-5 modal bypass
    - [x] T-0 lockout bypass (Continue Working)
    - [x] N:59 reset postpone
    [Source: docs/prd-session-timeline-smart-export.md#admin-configuration-ui]
  - [x] Hook the admin "dismiss T-5 warning" interaction (from Story 2.1 modal) to this logging requirement.  
    [Source: docs/prd-session-timeline-smart-export.md#admin-configuration-ui]
    [Source: docs/stories/2.1.session-timeline-core-warning-system.md#tasks--subtasks]
  - [x] Write logs to the existing offline log location under AppData.  
    [Source: docs/architecture/development-environment.md#local-setup-mvp]
    [Source: docs/architecture/infrastructure-and-deployment-integration.md#existing-infrastructure]
  - [x] Add a visible "admin override active" indicator in admin mode after any bypass/postpone action; persists until session reset.  
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]

- [ ] Task 7: Tests + validation scenarios (AC: 1-7)
  - [ ] Manual: verify customer lockout disables actions; admin can bypass; both paths do not crash the app.  
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  - [ ] Manual: verify N:59 reset returns to session entry in customer mode; admin postpone works; reset-now works.  
    [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  - [ ] Regression: verify locked state still permits browsing/viewing existing photos (read-only), and the session folder contract remains unchanged.  
    [Source: docs/prd-session-timeline-smart-export.md#story-22-t-0-lockout-application-reset-admin-settings]
    [Source: docs/stories/epic-2-session-timeline-smart-export.md#compatibility-requirements]

## Dev Notes

### Previous Story Insights

- Story 2.1 is currently `Draft` (this story is being prepared ahead of completion by request). Treat the event names documented in Story 2.1 as the contract to integrate with.  
  [Source: docs/stories/2.1.session-timeline-core-warning-system.md#status]
  [Source: docs/stories/2.1.session-timeline-core-warning-system.md#tasks--subtasks]

### Mode / Auth

- Customer/admin branching must be driven from backend mode/auth state with UI visibility/behavior following mode changes (single source of truth).  
  [Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend-react-ui]
  [Source: docs/architecture/security-integration.md#enhancement-security-requirements]
- Practical wiring (clarification): read initial mode via `boothy_get_mode_state` and subscribe to `boothy-mode-changed` to keep UI state consistent across the session.  
  [Source: docs/architecture/component-architecture.md#boothy-modeauth-tauri-backend-react-ui]

### Configuration (messages)

- Persist timeline message settings in AppData `settings.json` under a `boothy.*` namespace (append-only). Avoid introducing a separate monolithic config file unless it is already the established pattern.  
  [Source: docs/architecture/data-models-and-schema-changes.md#boothyappsettings-extension-of-rapidraw-appsettings]
- Defaults (must be restorable via UI):
  - End screen message: "이용해주셔서 감사합니다."  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]
  - T-5 warning message: "세션 종료가 5분 남았습니다"  
    [Source: docs/prd-session-timeline-smart-export.md#session-timeline-management]

### Logging

- Offline-first diagnostics: store logs under `%APPDATA%\\Boothy\\logs\\...` for field use (no remote monitoring required for MVP).  
  [Source: docs/architecture/development-environment.md#local-setup-mvp]
  [Source: docs/architecture/infrastructure-and-deployment-integration.md#existing-infrastructure]
- Clarification: write timeline/admin-override logs into the existing app log file `%APPDATA%\\Boothy\\logs\\boothy.log` (not a new log file), with clear action tags and timestamps.  
  [Source: docs/architecture/development-environment.md#local-setup-mvp]

### File Locations (Guidance)

- Product code lives under `apps/boothy` (React UI + Tauri backend).  
  [Source: docs/architecture/source-tree.md#new-file-organization]
- Follow naming conventions: Tauri commands `boothy_*`, events `boothy-*`.  
  [Source: docs/architecture/coding-standards.md#enhancement-specific-standards]

### Testing

- MVP quality gate relies on scenario-based manual validation, plus targeted unit tests where appropriate.  
  [Source: docs/architecture/testing-strategy.md#manual-testing-requirements-mvp-gate]
  [Source: docs/architecture/testing-strategy.md#unit-tests-for-new-components]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-16 | 0.1 | Initial draft created from Epic 2 PRD + architecture | Scrum Master (Bob) |
| 2026-01-16 | 0.2 | PO clarification: reset grace period, admin end-screen bypass UX, settings keys, logging target | Product Owner (Sarah) |
| 2026-01-16 | 0.3 | Finalized lockout/reset wiring and defensive capture guard; validations run | James (Dev) |

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex CLI)

### Debug Log References

None.

### Completion Notes List

- [x] Added lockout/reset modals, end screen overlay, and admin override logging/indicator wiring.
- [x] Added admin settings UI for end screen and T-5 warning messages with defaults and validation.
- [x] Guarded new-photo ingestion during lockout to prevent capture updates while locked.
- [x] Validated with `npm run build` and `cargo check` (warnings only in existing upstream code).
- [ ] Manual validation not run yet.

### File List

#### New Files Created

- [x] apps/boothy/src/components/modals/EndScreenModal.tsx
- [x] apps/boothy/src/components/modals/TimelineLockoutModal.tsx
- [x] apps/boothy/src/components/modals/TimelineResetModal.tsx
- [x] apps/boothy/src/utils/boothySettings.ts

#### Modified Files

- [x] apps/boothy/src/App.tsx
- [x] apps/boothy/src/components/panel/SettingsPanel.tsx
- [x] apps/boothy/src/components/panel/right/CropPanel.tsx
- [x] apps/boothy/src/components/panel/right/PresetsPanel.tsx
- [x] apps/boothy/src/components/ui/AppProperties.tsx
- [x] apps/boothy/src/window/TitleBar.tsx
- [x] apps/boothy/src-tauri/src/file_management.rs

## QA Results

TBD
